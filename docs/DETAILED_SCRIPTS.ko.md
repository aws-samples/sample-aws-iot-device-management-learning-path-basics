# 상세 스크립트 문서

이 문서는 AWS IoT Device Management 프로젝트의 각 스크립트에 대한 포괄적인 정보를 제공합니다. 모든 스크립트는 최적의 성능과 안정성을 위해 네이티브 AWS SDK(boto3)를 사용합니다.

## 핵심 스크립트

### scripts/provision_script.py
**목적**: 네이티브 boto3 API를 사용한 디바이스 관리 시나리오를 위한 완전한 AWS IoT 인프라 프로비저닝.

**기능**:
- 검색 가능한 속성(customerId, country, manufacturingDate)을 가진 사물 유형 생성
- VIN 스타일 명명(Vehicle-VIN-001)으로 수천 개의 IoT 디바이스 프로비저닝
- 펌웨어 패키지용 버전 관리가 포함된 Amazon S3 스토리지 설정
- 여러 버전의 AWS IoT 소프트웨어 패키지 생성
- 디바이스 쿼리를 위한 AWS IoT Fleet Indexing 구성
- 안전한 작업을 위한 AWS Identity and Access Management(IAM) 역할 설정
- 국가별 정적 사물 그룹 생성(Fleet 명명 규칙)
- **병렬 처리**: 더 빠른 프로비저닝을 위한 동시 작업
- **향상된 오류 처리**: 강력한 boto3 예외 처리

**대화형 입력**:
1. 사물 유형(기본값: SedanVehicle,SUVVehicle,TruckVehicle)
2. 패키지 버전(기본값: 1.0.0,1.1.0)
3. 대륙 선택(1-7)
4. 국가(개수 또는 특정 코드)
5. 디바이스 수(기본값: 100)

**명령줄 매개변수**:
- `--things-prefix PREFIX` - 사물 이름의 사용자 정의 접두사(기본값: "Vehicle-VIN-")
  - 1~20자여야 합니다
  - 영숫자, 하이픈, 밑줄, 콜론만 사용 가능
  - 예: `--things-prefix "Fleet-Device-"`는 Fleet-Device-001, Fleet-Device-002 등을 생성합니다

**리소스 태그 지정 동작**:
생성된 모든 리소스에는 자동으로 다음 태그가 지정됩니다:
- `workshop=learning-aws-iot-dm-basics` - 워크샵 리소스 식별
- `creation-date=YYYY-MM-DD` - 추적을 위한 타임스탬프

**태그가 지정되는 리소스**:
- 사물 유형
- 사물 그룹(정적 그룹)
- 소프트웨어 패키지
- 소프트웨어 패키지 버전
- 작업
- S3 버킷
- IAM 역할

**태그 실패 처리**:
- 태그 지정 실패가 리소스 생성을 방해하지 않습니다
- 스크립트는 실패한 태그에 대한 경고와 함께 계속됩니다
- 요약 보고서에 태그가 없는 리소스가 표시됩니다
- 정리 스크립트는 대체 수단으로 명명 패턴을 사용합니다

**교육적 일시 중지**: IoT 개념을 설명하는 8개의 학습 순간

**속도 제한**: 지능형 AWS API 스로틀링(사물 80 TPS, 사물 유형 8 TPS)

**성능**: 디버그 모드가 아닐 때 병렬 실행, 디버그 모드에서는 깔끔한 출력을 위해 순차 실행

**리소스 태그 지정**:
- **자동 워크샵 태그**: 모든 태그 지정 가능한 리소스에 `workshop=learning-aws-iot-dm-basics` 태그가 지정됩니다
- **지원되는 리소스**: 사물 유형, 사물 그룹, 패키지, 작업, S3 버킷, IAM 역할
- **태그 지정 불가능한 리소스**: 사물, 인증서, shadow는 명명 규칙에 의존합니다
- **태그 실패 처리**: 우아한 성능 저하 - 태그 지정이 실패해도 리소스 생성을 계속합니다
- **정리 통합**: 태그는 정리 작업 중 안전한 식별을 가능하게 합니다

**사물 명명 규칙**:
- **--things-prefix 매개변수**: 사물 이름의 구성 가능한 접두사(기본값: "Vehicle-VIN-")
- **명명 패턴**: `{prefix}{sequential_number}`(예: Vehicle-VIN-001, Vehicle-VIN-002)
- **순차 번호 지정**: 0으로 채워진 3자리 숫자(001-999)
- **접두사 검증**: 영숫자, 하이픈, 밑줄, 콜론만 사용 가능; 최대 20자
- **레거시 지원**: 이전 `vehicle-{country}-{type}-{index}` 패턴도 인식합니다
- **정리 통합**: 명명 패턴을 통해 태그 지정 불가능한 리소스를 식별할 수 있습니다

**사용 예**:
```bash
# 기본 접두사 사용(Vehicle-VIN-)
python scripts/provision_script.py

# 사용자 정의 접두사 사용
python scripts/provision_script.py --things-prefix "Fleet-Device-"

# 사용자 정의 접두사는 다음을 생성: Fleet-Device-001, Fleet-Device-002 등
```

---

### scripts/cleanup_script.py
**목적**: 네이티브 boto3 API를 사용한 지능형 리소스 식별로 지속적인 비용을 피하기 위한 AWS IoT 리소스의 안전한 제거.

**정리 옵션**:
1. **모든 리소스** - 완전한 인프라 정리
2. **사물만** - 디바이스 제거하지만 인프라 유지
3. **사물 그룹만** - 그룹화 제거하지만 디바이스 유지

**명령줄 매개변수**:
- `--things-prefix PREFIX` - 사물 식별을 위한 사용자 정의 접두사(기본값: "Vehicle-VIN-")
  - 프로비저닝 중에 사용한 접두사와 일치해야 합니다
  - 사용자 정의 명명 패턴을 가진 사물을 식별하는 데 사용됩니다
  - 예: `--things-prefix "Fleet-Device-"`는 Fleet-Device-001, Fleet-Device-002 등을 식별합니다
- `--dry-run` - 변경하지 않고 삭제될 항목 미리 보기
  - 삭제될 모든 리소스를 표시합니다
  - 각 리소스의 식별 방법을 표시합니다
  - 실제 삭제가 수행되지 않습니다
  - 실행 전에 정리 범위를 확인하는 데 유용합니다

**리소스 식별 방법**:

정리 스크립트는 워크샵 리소스를 안전하게 식별하기 위해 3계층 식별 시스템을 사용합니다:

**1. 태그 기반 식별(최우선 순위)**:
- `workshop=learning-aws-iot-dm-basics` 태그를 확인합니다
- 태그 지정으로 생성된 리소스에 가장 신뢰할 수 있는 방법입니다
- 작동 대상: 사물 유형, 사물 그룹, 패키지, 패키지 버전, 작업, S3 버킷, IAM 역할

**2. 명명 패턴 식별(대체 수단)**:
- 리소스 이름을 워크샵 패턴과 일치시킵니다
- 태그가 없거나 지원되지 않을 때 사용됩니다
- 패턴에는 다음이 포함됩니다:
  - 사물: `Vehicle-VIN-###` 또는 사용자 정의 접두사 패턴(예: `Fleet-Device-###`)
  - 사물 유형: `SedanVehicle`, `SUVVehicle`, `TruckVehicle`
  - 사물 그룹: `Fleet-*`(정적 그룹)
  - 동적 그룹: `DynamicGroup-*`
  - 패키지: `SedanVehicle-Package`, `SUVVehicle-Package`, `TruckVehicle-Package`
  - 작업: `OTA-Job-*`, `Command-Job-*`
  - S3 버킷: `iot-dm-workshop-*`
  - IAM 역할: `IoTJobsRole`, `IoTPackageConfigRole`

**3. 연결 기반 식별(태그 지정 불가능한 리소스용)**:
- 직접 태그를 지정할 수 없는 리소스에 사용됩니다
- 인증서: 워크샵 사물에 연결되어 식별됩니다
- Shadow: 워크샵 사물에 속하여 식별됩니다
- 종속 리소스의 완전한 정리를 보장합니다

**식별 프로세스**:
1. 각 리소스에 대해 먼저 태그를 확인합니다
2. 워크샵 태그가 없으면 명명 패턴을 확인합니다
3. 패턴 일치가 없으면 연결을 확인합니다(인증서/shadow용)
4. 식별 방법이 성공하지 못하면 리소스를 건너뜁니다
5. 디버그 모드는 각 리소스를 식별한 방법을 표시합니다

**기능**:
- **네이티브 boto3 구현**: CLI 종속성 없음, 더 나은 오류 처리
- **지능형 리소스 식별**: 3계층 시스템(태그 → 명명 → 연결)
- **드라이런 모드**: 변경하지 않고 삭제 미리 보기
- **사용자 정의 접두사 지원**: 사용자 정의 명명 패턴을 가진 사물 식별
- 지능형 속도 제한을 가진 **병렬 처리**
- **향상된 S3 정리**: 페이지네이터를 사용한 적절한 버전 관리 객체 삭제
- 정적 그룹과 동적 그룹을 자동으로 구분
- 사물 유형 사용 중단 처리(5분 대기)
- 상태 모니터링과 함께 AWS IoT Jobs 취소 및 삭제
- 포괄적인 IAM 역할 및 정책 정리
- Fleet Indexing 구성 비활성화
- **Shadow 정리**: 클래식 및 $package shadow 모두 제거
- **주체 분리**: 인증서 및 정책을 적절하게 분리
- **포괄적인 보고**: 개수와 함께 삭제 및 건너뛴 리소스 표시

**안전 기능**:
- 확인을 위해 "DELETE" 입력 필요(드라이런 모드 제외)
- 비워크샵 리소스를 자동으로 건너뜁니다
- 삭제될 항목의 요약을 표시합니다
- 실제 삭제 전 확인을 위한 드라이런 모드
- 개별 리소스가 실패해도 정리를 계속하는 오류 처리

**드라이런 모드 예**:
```bash
python scripts/cleanup_script.py --dry-run
```
출력 내용:
- 삭제될 리소스(식별 방법 포함)
- 건너뛸 리소스(비워크샵 리소스)
- 리소스 유형별 총 개수
- 실제 삭제가 수행되지 않음

**사용자 정의 접두사 예**:
```bash
python scripts/cleanup_script.py --things-prefix "Fleet-Device-"
```
식별 및 삭제:
- Fleet-Device-### 패턴과 일치하는 사물
- 연결된 인증서 및 shadow
- 기타 워크샵 리소스(태그 또는 패턴으로 식별)

**성능**: AWS API 제한을 준수하는 병렬 실행(사물 80 TPS, 동적 그룹 4 TPS)

**태그 기반 정리 예**:
```
사물 유형 스캔 중...
3개의 사물 유형을 찾았습니다
  ✓ SedanVehicle(태그로 식별: workshop=learning-aws-iot-dm-basics)
  ✓ SUVVehicle(태그로 식별: workshop=learning-aws-iot-dm-basics)
  ✓ TruckVehicle(태그로 식별: workshop=learning-aws-iot-dm-basics)

사물 그룹 스캔 중...
5개의 사물 그룹을 찾았습니다
  ✓ fleet-US(태그로 식별: workshop=learning-aws-iot-dm-basics)
  ✓ fleet-CA(태그로 식별: workshop=learning-aws-iot-dm-basics)
  ✗ production-fleet(건너뜀 - 워크샵 태그 없음)
```

**명명 기반 정리 예**:
```
사물 스캔 중...
102개의 사물을 찾았습니다
  ✓ Vehicle-VIN-001(명명 패턴으로 식별: Vehicle-VIN-###)
  ✓ Vehicle-VIN-002(명명 패턴으로 식별: Vehicle-VIN-###)
  ✓ vehicle-US-sedan-1(레거시 패턴으로 식별)
  ✗ production-device-001(건너뜀 - 패턴 일치 없음)
```

**연결 기반 정리 예**:
```
사물 처리 중: Vehicle-VIN-001
  ✓ 클래식 shadow(워크샵 사물과의 연결로 식별)
  ✓ $package shadow(워크샵 사물과의 연결로 식별)
  ✓ 인증서 abc123(워크샵 사물과의 연결로 식별)
  
사물 처리 중: production-device-001
  ✗ 인증서 xyz789(건너뜀 - 비워크샵 사물에 연결됨)
```

**정리 요약 출력**:
```
정리 요약:
================
삭제된 리소스:
  - IoT 사물: 100
  - 사물 그룹: 5
  - 사물 유형: 3
  - 패키지: 3
  - 작업: 2
  - S3 버킷: 1
  - IAM 역할: 2
  총계: 116

건너뛴 리소스:
  - IoT 사물: 2(비워크샵 리소스)
  - 사물 그룹: 1(비워크샵 리소스)
  총계: 3

실행 시간: 45.3초
```

**정리 문제 해결**:

**문제: 리소스가 삭제되지 않음**

증상:
- 정리 스크립트가 삭제되어야 할 리소스를 건너뜁니다
- "건너뛴 리소스" 개수가 예상보다 높습니다
- 정리 후 특정 리소스가 남아 있습니다

해결책:
1. **사물 접두사 일치 확인**:
   ```bash
   # 프로비저닝 중에 사용자 정의 접두사를 사용한 경우:
   python scripts/provision_script.py --things-prefix "MyPrefix-"
   
   # 정리 중에 동일한 접두사를 사용해야 합니다:
   python scripts/cleanup_script.py --things-prefix "MyPrefix-"
   ```

2. **리소스 태그 확인**:
   - 디버그 모드에서 정리를 실행하여 식별 방법을 확인합니다
   - 태그 지정 가능한 리소스에 `workshop=learning-aws-iot-dm-basics` 태그가 있는지 확인합니다
   - AWS 콘솔 → IoT Core → 리소스 태그를 확인합니다

3. **명명 패턴 확인**:
   - 사물은 다음과 일치해야 합니다: `{prefix}###` 또는 `vehicle-{country}-{type}-{index}`
   - 그룹은 다음과 일치해야 합니다: `fleet-{country}` 또는 "workshop" 포함
   - 드라이런 모드를 사용하여 식별될 항목을 확인합니다

4. **먼저 드라이런 사용**:
   ```bash
   # 삭제될 항목 미리 보기
   python scripts/cleanup_script.py --dry-run
   
   # 건너뛴 리소스에 대한 출력 확인
   # 디버그 모드에서 식별 방법 확인
   ```

**문제: 프로비저닝 중 태그 적용 실패**

증상:
- 프로비전 스크립트가 "태그 적용 실패" 경고를 표시합니다
- 리소스는 생성되었지만 워크샵 태그가 없습니다
- 정리 스크립트가 삭제되어야 할 리소스를 건너뜁니다

해결책:
1. **IAM 권한 확인**:
   - IAM 사용자/역할에 태그 지정 권한이 있는지 확인합니다
   - 필요한 작업: `iot:TagResource`, `s3:PutBucketTagging`, `iam:TagRole`

2. **명명 규칙에 의존**:
   - 태그가 없는 리소스도 명명 패턴으로 식별할 수 있습니다
   - 프로비저닝 중에 일관된 명명을 보장합니다
   - 프로비전 및 정리에 동일한 --things-prefix를 사용합니다

3. **수동 태그 추가**(필요한 경우):
   ```bash
   # AWS CLI를 통해 수동으로 태그 추가
   aws iot tag-resource --resource-arn <arn> --tags workshop=learning-aws-iot-dm-basics
   ```

**문제: 정리가 잘못된 리소스를 삭제함**

증상:
- 비워크샵 리소스가 삭제 대상으로 식별됩니다
- 드라이런이 예상치 못한 리소스를 표시합니다

해결책:
1. **항상 먼저 드라이런 사용**:
   ```bash
   python scripts/cleanup_script.py --dry-run
   ```

2. **명명 패턴 검토**:
   - 프로덕션 리소스가 워크샵 패턴과 일치하지 않는지 확인합니다
   - 프로덕션 사물에 "Vehicle-VIN-" 접두사를 사용하지 마십시오
   - 프로덕션 그룹에 "fleet-" 접두사를 사용하지 마십시오

3. **태그 충돌 확인**:
   - 프로덕션 리소스에 워크샵 태그가 없는지 확인합니다
   - AWS 계정의 태그 정책을 검토합니다

**문제: 정리가 권한 오류로 실패함**

증상:
- "AccessDeniedException" 또는 "UnauthorizedException" 오류
- 부분적인 정리 완료
- 일부 리소스 유형은 삭제되고 다른 유형은 건너뜁니다

해결책:
1. **IAM 권한 확인**:
   - README.md에 나열된 필요한 권한
   - 모든 필요한 작업에 대한 IAM 정책 확인
   - IoT, S3, IAM, Fleet Indexing에 대한 권한 확인

2. **리소스 정책 확인**:
   - S3 버킷 정책이 삭제를 차단할 수 있습니다
   - IAM 역할 신뢰 정책이 삭제를 방해할 수 있습니다
   - 리소스 수준 정책을 검토합니다

3. **디버그 모드 사용**:
   ```bash
   # 디버그로 실행하여 정확한 API 오류 확인
   python scripts/cleanup_script.py
   # 디버그 모드에 대해 'y'로 답변
   ```

**문제: 정리 시간이 너무 오래 걸림**

증상:
- 정리가 오랜 시간 동안 실행됩니다
- 진행이 느린 것처럼 보입니다
- 시간 초과 오류

해결책:
1. **예상 기간**:
   - 100개 사물: 약 2~3분
   - 1000개 사물: 약 15~20분
   - 사물 유형 삭제: +5분(필요한 사용 중단 대기)

2. **속도 제한**:
   - 스크립트는 AWS API 제한을 자동으로 준수합니다
   - 병렬 처리가 성능을 최적화합니다
   - 디버그 모드는 순차적으로 실행됩니다(느리지만 출력이 명확함)

3. **진행 상황 모니터링**:
   - 실시간 진행 표시기를 확인합니다
   - AWS 콘솔에서 삭제 상태를 확인합니다
   - 디버그 모드를 사용하여 각 작업을 확인합니다

**문제: 드라이런이 실제 정리와 다른 결과를 표시함**

증상:
- 드라이런이 식별하는 리소스를 실제 정리가 건너뜁니다
- 모드 간에 일관성 없는 동작

해결책:
1. **리소스 상태 변경**:
   - 드라이런과 실제 정리 사이에 리소스가 수정될 수 있습니다
   - 다른 프로세스에 의해 태그가 추가/제거될 수 있습니다
   - 실제 정리 직전에 드라이런을 다시 실행합니다

2. **동시 수정**:
   - 다른 사용자/프로세스가 리소스를 수정하고 있을 수 있습니다
   - 팀과 정리 타이밍을 조정합니다
   - 가능한 경우 리소스 잠금을 사용합니다

3. **캐싱 문제**:
   - AWS API 응답이 잠시 캐시될 수 있습니다
   - 드라이런과 실제 정리 사이에 몇 초 기다립니다
   - AWS 콘솔을 새로 고쳐 현재 상태를 확인합니다

**문제: 부분적인 정리**

증상:
- 일부 리소스는 삭제되고 다른 리소스는 남아 있습니다
- 정리 중 오류 메시지
- 불완전한 정리 결과

해결책:
1. **종속성 문제**:
   - 일부 리소스는 종속성으로 인해 삭제에 실패할 수 있습니다
   - 스크립트는 나머지 리소스로 계속됩니다
   - 특정 실패에 대한 오류 메시지를 확인합니다
   - 스크립트를 다시 실행하여 나머지 리소스를 정리합니다

2. **리소스 상태**:
   - 사물 유형은 삭제 전에 사용 중단되어야 합니다(5분 대기)
   - 작업은 삭제 전에 취소되어야 합니다
   - S3 버킷은 삭제 전에 비워야 합니다

3. **정리 다시 실행**:
   ```bash
   # 나머지 리소스를 포착하기 위해 정리를 다시 실행
   python scripts/cleanup_script.py
   ```

**안전한 정리를 위한 모범 사례**:

1. **항상 드라이런으로 시작**:
   ```bash
   python scripts/cleanup_script.py --dry-run
   ```

2. **사물 접두사 일치 확인**:
   - 프로비저닝과 동일한 --things-prefix 사용
   - 팀 참조를 위해 사용자 정의 접두사를 문서화합니다

3. **문제 해결에 디버그 모드 사용**:
   - 각 리소스의 식별 방법을 확인합니다
   - 리소스가 건너뛰어지는 이유를 이해합니다
   - 태그 및 명명 패턴 일치를 확인합니다

4. **팀과 조정**:
   - 정리 타이밍을 전달합니다
   - 리소스를 사용하는 활성 워크샵이 없는지 확인합니다
   - 정리 결과를 문서화합니다

5. **AWS 콘솔 모니터링**:
   - 리소스가 예상대로 삭제되었는지 확인합니다
   - 남아 있는 워크샵 리소스를 확인합니다
   - 사용 가능한 경우 CloudWatch 로그를 확인합니다

6. **일관된 명명 유지**:
   - 워크샵 전체에서 표준 접두사를 사용합니다
   - 명명 규칙을 문서화합니다
   - 프로덕션 명명 충돌을 피합니다

**태그 기반 정리가 작동하지 않음**:
- 리소스가 태그 지정이 활성화된 상태로 생성되었는지 확인합니다
- 프로비저닝 중 태그 지정이 실패했는지 확인합니다(프로비전 스크립트 출력 참조)
- 명명 패턴 식별이 대체 수단으로 사용됩니다
- `--dry-run`을 사용하여 식별 방법을 확인하는 것을 고려합니다

---


### scripts/create_job.py
**목적**: 네이티브 boto3 API를 사용한 무선(OTA) 펌웨어 업데이트를 위한 AWS IoT Jobs 생성.

**기능**:
- **네이티브 boto3 구현**: 더 나은 성능을 위한 직접 API 호출
- 대화형 사물 그룹 선택(단일 또는 다중)
- ARN 확인을 통한 패키지 버전 선택
- 연속 작업 구성(새 디바이스 자동 포함)
- 사전 서명된 URL 구성(1시간 만료)
- 다중 그룹 타겟팅 지원
- **향상된 작업 유형**: OTA 및 사용자 정의 작업 유형 모두 지원
- **고급 구성**: 롤아웃 정책, 중단 기준, 시간 초과 설정

**작업 구성**:
- 타임스탬프가 포함된 자동 생성 작업 ID
- AWS IoT 사전 서명된 URL 자리 표시자
- 리소스에 대한 적절한 ARN 형식 지정
- 포괄적인 작업 문서 구조
- **교육 콘텐츠**: 작업 구성 옵션 설명

---

### scripts/simulate_job_execution.py
**목적**: 네이티브 boto3 API를 사용한 펌웨어 업데이트 중 실제 디바이스 동작 시뮬레이션.

**기능**:
- **네이티브 boto3 구현**: 직접 IoT Jobs Data API 통합
- 사전 서명된 URL을 통한 실제 Amazon S3 아티팩트 다운로드
- **고성능 병렬 실행**(세마포어 제어로 150 TPS)
- 구성 가능한 성공/실패율
- **가시적인 계획 준비** - 각 디바이스에 성공/실패 상태가 할당되는 것을 표시
- **사용자 확인** - 계획 준비 후 진행 여부를 묻습니다
- **작업 가시성** - 각 디바이스의 다운로드 진행 상황 및 작업 상태 업데이트 표시
- **향상된 오류 처리**: 강력한 boto3 예외 관리
- 상세한 보고를 통한 진행 상황 추적
- **깔끔한 JSON 형식**: 적절하게 형식화된 작업 문서 표시

**프로세스 흐름**:
1. 네이티브 API를 사용하여 활성 작업 스캔
2. 대기 중인 실행 가져오기(QUEUED/IN_PROGRESS)
3. **실행 계획 준비** - 디바이스 할당을 표시하고 확인을 요청
4. Amazon S3에서 실제 펌웨어 다운로드(디바이스당 진행 상황 표시)
5. IoT Jobs Data API를 사용하여 작업 실행 상태 업데이트
6. 포괄적인 성공/실패 통계 보고

**성능 개선**:
- **병렬 처리**: 디버그 모드가 아닐 때 동시 실행
- **속도 제한**: 지능형 세마포어 기반 스로틀링
- **메모리 효율성**: 대용량 펌웨어 파일을 위한 스트리밍 다운로드

**가시성 개선**:
- 계획 준비 표시: `[1/100] Vehicle-VIN-001 -> SUCCESS`
- 다운로드 진행 상황 표시: `Vehicle-VIN-001: S3에서 펌웨어 다운로드 중...`
- 파일 크기 확인: `Vehicle-VIN-001: 2.1KB 펌웨어 다운로드 완료`
- 상태 업데이트 표시: `Vehicle-VIN-001: 작업 실행 성공`

---

### scripts/explore_jobs.py
**목적**: 네이티브 boto3 API를 사용한 모니터링 및 문제 해결을 위한 AWS IoT Jobs의 대화형 탐색.

**메뉴 옵션**:
1. **모든 작업 나열** - 병렬 스캔을 통한 모든 상태의 개요
2. **특정 작업 탐색** - 깔끔한 JSON 형식의 상세한 작업 구성
3. **작업 실행 탐색** - IoT Jobs Data API를 사용한 개별 디바이스 진행 상황
4. **작업 실행 나열** - 병렬 상태 확인을 통한 작업의 모든 실행
5. **작업 취소** - 영향 분석 및 교육 지침을 통한 활성 작업 취소
6. **작업 삭제** - 자동 강제 플래그 처리를 통한 완료/취소된 작업 삭제
7. **통계 보기** - 상태 평가 및 권장 사항이 포함된 포괄적인 작업 분석

**기능**:
- **네이티브 boto3 구현**: 더 나은 성능을 위한 직접 API 통합
- **병렬 작업 스캔**: 모든 작업 상태에 걸친 동시 상태 확인
- **깔끔한 JSON 표시**: 이스케이프 문자 없이 적절하게 형식화된 작업 문서
- 색상으로 구분된 상태 표시기
- 사용 가능한 작업 목록이 포함된 대화형 작업 선택
- 상세한 사전 서명된 URL 구성 표시
- 색상 코딩이 포함된 실행 요약 통계
- **향상된 오류 처리**: 강력한 boto3 예외 관리
- 연속 탐색 루프
- **작업 수명 주기 관리**: 안전 확인을 통한 취소 및 삭제 작업
- **고급 분석**: 상태 평가가 포함된 포괄적인 통계

**작업 취소 기능**:
- 활성 작업 스캔(IN_PROGRESS, SCHEDULED)
- 작업 세부 정보 및 대상 개수 표시
- 상태별 실행 개수를 통한 영향 분석(QUEUED, IN_PROGRESS, SUCCEEDED, FAILED)
- 작업을 취소하는 시기와 이유를 설명하는 교육 콘텐츠
- 진행하려면 "CANCEL"을 입력해야 하는 안전 확인
- 감사 추적을 위한 선택적 취소 주석
- 실시간 상태 업데이트

**작업 삭제 기능**:
- 삭제 가능한 작업 스캔(COMPLETED, CANCELED)
- 작업 완료 타임스탬프 표시
- 실행 기록을 확인하여 강제 플래그가 필요한지 판단
- 삭제 영향에 대한 교육 콘텐츠
- 실행이 있을 때 자동 강제 플래그
- 진행하려면 "DELETE"를 입력해야 하는 안전 확인
- 취소와 삭제 작업의 차이점 설명

**통계 보기 기능**:
- 포괄적인 작업 개요(상태, 생성/완료 날짜, 대상)
- 상태별 백분율이 포함된 실행 통계
- 성공/실패율 계산
- 모든 실행 상태의 상세한 분석
- 상태 평가(우수 ≥95%, 양호 ≥80%, 불량 ≥50%, 심각 <50%)
- 실행 상태 및 실패 패턴에 대한 교육 콘텐츠
- 작업 상태에 따른 상황별 권장 사항:
  - 실행 없음: 디바이스 연결 및 그룹 멤버십 확인
  - 조기 취소: 취소 이유 검토
  - 디바이스 제거됨: 디바이스 존재 확인
  - 진행 중: 대기 및 모니터링
  - 높은 실패율: 조사 및 취소 고려
  - 중간 실패: 면밀히 모니터링
  - 우수한 성능: 성공 패턴 문서화

**성능 개선**:
- **병렬 처리**: 디버그 모드가 아닐 때 동시 작업
- **지능형 페이지네이션**: 대규모 작업 목록의 효율적인 처리
- **속도 제한**: 세마포어를 사용한 적절한 API 스로틀링

---

### scripts/manage_packages.py
**목적**: 네이티브 boto3 API를 사용한 AWS IoT 소프트웨어 패키지, 디바이스 추적 및 버전 롤백의 포괄적인 관리.

**작업**:
1. **패키지 생성** - 새 소프트웨어 패키지 컨테이너 생성
2. **버전 생성** - S3 펌웨어 업로드 및 게시를 통한 버전 추가(학습 순간 포함)
3. **패키지 나열** - 대화형 설명 옵션이 포함된 패키지 표시
4. **패키지 설명** - 버전 탐색이 포함된 패키지 세부 정보 표시
5. **버전 설명** - 특정 버전 세부 정보 및 Amazon S3 아티팩트 표시
6. **구성 확인** - 패키지 구성 상태 및 IAM 역할 보기
7. **구성 활성화** - IAM 역할 생성을 통한 자동 shadow 업데이트 활성화
8. **구성 비활성화** - 자동 shadow 업데이트 비활성화
9. **디바이스 버전 확인** - 특정 디바이스의 $package shadow 검사(다중 디바이스 지원)
10. **버전 되돌리기** - Fleet Indexing을 사용한 플릿 전체 버전 롤백

**주요 기능**:
- **Amazon S3 통합**: 버전 관리를 통한 자동 펌웨어 업로드
- **대화형 탐색**: 목록, 설명 및 버전 작업 간의 원활한 흐름
- **패키지 구성 관리**: Jobs-to-Shadow 통합 제어
- **디바이스 추적**: 개별 디바이스 패키지 버전 검사
- **플릿 롤백**: Fleet Indexing 쿼리를 사용한 버전 되돌리기
- **교육적 접근**: 워크플로 전반에 걸친 학습 순간
- **IAM 역할 관리**: 패키지 구성을 위한 자동 역할 생성

**패키지 구성**:
- **상태 확인**: 활성화/비활성화 상태 및 IAM 역할 ARN 표시
- **활성화**: $package shadow 권한이 있는 IoTPackageConfigRole 생성
- **비활성화**: 작업 완료 시 자동 shadow 업데이트 중지
- **교육**: Jobs-to-Shadow 통합 및 IAM 요구 사항 설명

**디바이스 버전 추적**:
- **다중 디바이스 지원**: 여러 디바이스를 순차적으로 확인
- **$package Shadow 검사**: 현재 펌웨어 버전 및 메타데이터 표시
- **타임스탬프 표시**: 각 패키지의 마지막 업데이트 정보
- **오류 처리**: 누락된 디바이스 또는 shadow에 대한 명확한 메시지

**버전 롤백**:
- **Fleet Indexing 쿼리**: 사물 유형 및 버전별로 디바이스 찾기
- **디바이스 목록 미리보기**: 되돌릴 디바이스 표시(처음 10개 + 개수)
- **확인 필요**: shadow 업데이트를 진행하려면 'REVERT' 입력
- **개별 디바이스 상태**: 디바이스당 되돌리기 성공/실패 표시
- **진행 상황 추적**: 성공 개수가 포함된 실시간 업데이트 상태
- **교육**: 롤백 개념 및 shadow 관리 설명

**롤백 가시성**:
- 디바이스 미리보기: `1. Vehicle-VIN-001`, `2. Vehicle-VIN-002`, `... 그리고 90개 더`
- 개별 결과: `Vehicle-VIN-001: 버전 1.0.0으로 되돌림`
- 실패한 시도: `Vehicle-VIN-002: 되돌리기 실패`

**학습 초점**:
- 생성부터 롤백까지의 완전한 펌웨어 수명 주기
- 패키지 구성 및 자동 shadow 업데이트
- 디바이스 인벤토리 관리 및 추적
- 버전 관리 작업을 위한 Fleet Indexing

---

### scripts/manage_dynamic_groups.py
**목적**: 네이티브 boto3 API를 사용한 Fleet Indexing 검증을 통한 동적 사물 그룹의 포괄적인 관리.

**작업**:
1. **동적 그룹 생성** - 두 가지 생성 방법:
   - **안내 마법사**: 대화형 기준 선택
   - **사용자 정의 쿼리**: 직접 Fleet Indexing 쿼리 입력
2. **동적 그룹 나열** - 멤버 개수 및 쿼리와 함께 모든 그룹 표시
3. **동적 그룹 삭제** - 확인을 통한 안전한 삭제
4. **쿼리 테스트** - 사용자 정의 Fleet Indexing 쿼리 검증

**생성 방법**:
- **안내 마법사**(모두 선택 사항):
  - 국가: 단일 또는 다중(예: US,CA,MX)
  - 사물 유형: 차량 카테고리(예: SedanVehicle)
  - 버전: 단일 또는 다중(예: 1.0.0,1.1.0)
  - 배터리 수준: 비교(예: >50, <30, =75)
- **사용자 정의 쿼리**: 직접 Fleet Indexing 쿼리 문자열 입력

**기능**:
- **이중 생성 모드**: 안내 마법사 또는 사용자 정의 쿼리 입력
- 스마트 그룹 명명(자동 생성 또는 사용자 정의)
- Fleet Indexing 쿼리 구성 및 검증
- **실시간 디바이스 일치 미리보기**(생성 전 일치하는 디바이스 표시)
- 기존 그룹의 멤버 개수 표시
- 확인 프롬프트를 통한 안전한 삭제
- 사용자 정의 쿼리 테스트 기능
- 쿼리 검증으로 빈 그룹 생성 방지

**쿼리 예제**:
- 단일 기준: `thingTypeName:SedanVehicle AND attributes.country:US`
- 다중 기준: `thingTypeName:SedanVehicle AND attributes.country:(US OR CA) AND shadow.reported.batteryStatus:[50 TO *]`
- 패키지 버전: `shadow.name.\$package.reported.SedanVehicle.version:1.1.0`
- 사용자 정의 복합: `(thingTypeName:SedanVehicle OR thingTypeName:SUVVehicle) AND attributes.country:US AND shadow.reported.batteryStatus:[30 TO 80]`

---

### scripts/check_syntax.py
**목적**: CI/CD 파이프라인을 위한 게시 전 구문 검증.

**확인 사항**:
- 모든 스크립트의 Python 구문 검증
- 가져오기 가용성 확인
- requirements.txt 검증
- 종속성 나열

**사용법**: GitHub Actions 워크플로에서 자동으로 실행

---

## 스크립트 종속성

### 필수 Python 패키지
- `boto3>=1.40.27` - Python용 AWS SDK(패키지 아티팩트 지원을 위한 최신 버전)
- `colorama>=0.4.4` - 터미널 색상
- `requests>=2.25.1` - Amazon S3 다운로드를 위한 HTTP 요청

### 사용되는 AWS 서비스
- **AWS IoT Core** - 사물 관리, 작업, shadow
- **AWS IoT Device Management** - 소프트웨어 패키지, Fleet Indexing
- **Amazon S3** - 버전 관리를 통한 펌웨어 스토리지
- **AWS Identity and Access Management(IAM)** - 안전한 액세스를 위한 역할 및 정책

### AWS 자격 증명 요구 사항
- 다음을 통해 구성된 자격 증명:
  - `aws configure`(AWS CLI)
  - 환경 변수(AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
  - IAM 역할(EC2/Lambda 실행용)
  - AWS 자격 증명 파일
- AWS IoT, Amazon S3 및 IAM 작업에 대한 적절한 IAM 권한
- 리전 구성(AWS_DEFAULT_REGION 환경 변수 또는 자격 증명)

## 교육 기능

### 학습 순간
각 스크립트에는 다음을 설명하는 교육적 일시 중지가 포함됩니다:
- AWS IoT 개념 및 아키텍처
- 디바이스 관리 모범 사례
- 보안 고려 사항
- 확장성 패턴

### 진행 상황 추적
- 실시간 작업 상태
- 성공/실패 개수
- 성능 메트릭(TPS, 기간)
- 쉽게 읽을 수 있도록 색상으로 구분된 출력

### 디버그 모드
모든 스크립트에서 사용 가능:
- 매개변수와 함께 모든 AWS SDK(boto3) API 호출 표시
- JSON 형식의 완전한 API 응답 표시
- 전체 스택 추적이 포함된 상세한 오류 정보 제공
- **순차 처리**: 깔끔한 디버그 출력을 위해 작업을 순차적으로 실행
- AWS API 문제 해결 및 학습에 도움

## 성능 특성

### 속도 제한
스크립트는 AWS API 제한을 준수합니다:
- 사물 작업: 80 TPS(100 TPS 제한)
- 사물 유형: 8 TPS(10 TPS 제한)
- 동적 그룹: 4 TPS(5 TPS 제한)
- 작업 실행: 150 TPS(200 TPS 제한)
- 패키지 작업: 8 TPS(10 TPS 제한)

### 병렬 처리
- **네이티브 boto3 통합**: 더 나은 성능을 위한 직접 AWS SDK 호출
- 동시 작업을 위한 ThreadPoolExecutor(디버그 모드가 아닐 때)
- **지능형 속도 제한**: AWS API 제한을 준수하는 세마포어
- **스레드 안전 진행 상황 추적**: 동시 작업 모니터링
- **향상된 오류 처리**: 강력한 boto3 ClientError 예외 관리
- **디버그 모드 재정의**: 깔끔한 출력을 위해 디버그 모드에서 순차 처리

### 메모리 관리
- 대용량 파일을 위한 스트리밍 다운로드
- 임시 파일 정리
- 효율적인 JSON 파싱
- 종료 시 리소스 정리

---

### scripts/manage_commands.py
**목적**: 네이티브 boto3 API를 사용하여 IoT 디바이스에 실시간 명령을 전송하기 위한 AWS IoT Commands의 포괄적인 관리.

**작업**:
1. **명령 생성** - 페이로드 형식 정의가 포함된 새 명령 템플릿 생성
2. **명령 나열** - 모든 명령 템플릿 표시(사전 정의 및 사용자 정의)
3. **명령 세부 정보 보기** - 완전한 명령 템플릿 사양 표시
4. **명령 삭제** - 안전 확인을 통한 사용자 정의 명령 템플릿 제거
5. **명령 실행** - 디바이스 또는 사물 그룹에 명령 전송
6. **명령 상태 보기** - 명령 실행 진행 상황 및 결과 모니터링
7. **명령 기록 보기** - 필터링을 통한 과거 명령 실행 찾아보기
8. **명령 취소** - 대기 중이거나 진행 중인 명령 실행 취소
9. **디버그 모드 활성화/비활성화** - 상세한 API 로깅 전환
10. **종료** - 스크립트 종료

**주요 기능**:
- **네이티브 boto3 구현**: 직접 AWS IoT Commands API 통합
- **사전 정의된 자동차 템플릿**: 6개의 즉시 사용 가능한 차량 명령 템플릿
- **명령 템플릿 관리**: 명령 템플릿 생성, 나열, 보기 및 삭제
- **명령 실행**: 개별 디바이스 또는 사물 그룹에 명령 전송
- **상태 모니터링**: 진행 표시기가 포함된 실시간 명령 실행 추적
- **명령 기록**: 과거 명령 실행 찾아보기 및 필터링
- **명령 취소**: 대기 중이거나 진행 중인 명령 취소
- **IoT Core 스크립트 통합**: certificate_manager 및 mqtt_client_explorer와의 원활한 통합
- **MQTT 주제 문서**: 완전한 주제 구조 참조
- **디바이스 시뮬레이션 예제**: 성공 및 실패 응답 페이로드
- **교육적 접근**: 워크플로 전반에 걸친 학습 순간
- **다국어 지원**: 6개 언어에 대한 완전한 i18n 지원

**사전 정의된 자동차 명령 템플릿**:
스크립트에는 일반적인 차량 작업을 위한 6개의 사전 정의된 명령 템플릿이 포함되어 있습니다:

1. **vehicle-lock** - 원격으로 차량 도어 잠금
   - 페이로드: `{"action": "lock", "vehicleId": "string"}`
   - 사용 사례: 보안을 위한 원격 도어 잠금

2. **vehicle-unlock** - 원격으로 차량 도어 잠금 해제
   - 페이로드: `{"action": "unlock", "vehicleId": "string"}`
   - 사용 사례: 액세스를 위한 원격 도어 잠금 해제

3. **start-engine** - 원격으로 차량 엔진 시동
   - 페이로드: `{"action": "start", "vehicleId": "string", "duration": "number"}`
   - 사용 사례: 기후 제어를 위한 원격 엔진 시동

4. **stop-engine** - 원격으로 차량 엔진 정지
   - 페이로드: `{"action": "stop", "vehicleId": "string"}`
   - 사용 사례: 긴급 엔진 종료

5. **set-climate** - 차량 기후 온도 설정
   - 페이로드: `{"action": "setClimate", "vehicleId": "string", "temperature": "number", "unit": "string"}`
   - 사용 사례: 차량 온도 사전 조절

6. **activate-horn** - 차량 경적 활성화
   - 페이로드: `{"action": "horn", "vehicleId": "string", "duration": "number"}`
   - 사용 사례: 차량 위치 지원

**명령 템플릿 관리**:

**명령 템플릿 생성**:
- 명령 이름, 설명 및 페이로드 형식에 대한 대화형 프롬프트
- 페이로드 구조에 대한 JSON 스키마 검증
- AWS-IoT 네임스페이스 구성
- contentType이 포함된 바이너리 blob 페이로드 처리
- 자동 ARN 생성 및 표시
- AWS IoT Commands 요구 사항에 대한 검증:
  - 이름: 1-128자, 영숫자/하이픈/밑줄, 영숫자로 시작해야 함
  - 설명: 1-256자
  - 페이로드: 유효한 JSON 스키마, 최대 10KB 복잡도

**명령 템플릿 나열**:
- 사전 정의 및 사용자 정의 템플릿 모두 표시
- 다음이 포함된 색상으로 구분된 테이블 형식:
  - 템플릿 이름
  - 설명
  - 생성 날짜
  - 템플릿 ARN
  - 상태(ACTIVE, DEPRECATED, PENDING_DELETION)
- 템플릿 세부 정보를 보기 위한 대화형 탐색
- 대규모 템플릿 목록에 대한 페이지네이션 지원

**명령 세부 정보 보기**:
- 완전한 페이로드 형식 사양 표시
- 매개변수 이름, 유형 및 제약 조건
- 필수 필드 대 선택적 필드
- 예제 매개변수 값
- 템플릿 메타데이터(생성 날짜, ARN, 상태)
- 페이로드 구조에 대한 깔끔한 JSON 형식

**명령 템플릿 삭제**:
- 진행하려면 "DELETE"를 입력해야 하는 안전 확인
- 활성 명령이 템플릿을 사용하지 않는지 확인
- 사전 정의된 템플릿 삭제 방지
- 삭제 실패에 대한 명확한 오류 메시지
- 템플릿 리소스 자동 정리

**명령 실행**:

**명령 실행**:
- 사용 가능한 템플릿에서 대화형 명령 템플릿 선택
- 대상 선택:
  - 단일 디바이스(사물 이름)
  - 사물 그룹(그룹 이름)
- 대상 검증:
  - IoT 레지스트리에서 디바이스 존재 확인
  - 멤버 개수 표시가 포함된 사물 그룹 검증
- 템플릿 페이로드 형식과 일치하는 매개변수 수집
- 구성 가능한 실행 시간 초과(기본값 60초)
- 다음으로 자동 MQTT 주제 게시:
  - `$aws/commands/things/<ThingName>/executions/<ExecutionId>/request/json`
- 다음이 포함된 성공 표시:
  - 명령 실행 ID
  - 초기 상태(CREATED/IN_PROGRESS)
  - MQTT 주제 정보
- 다중 대상 지원(대상당 별도의 실행 생성)

**명령 상태 모니터링**:

**명령 상태 보기**:
- GetCommandExecution API를 사용한 실시간 상태 검색
- 상태 표시에는 다음이 포함됩니다:
  - 명령 실행 ID
  - 대상 디바이스/그룹 이름
  - 현재 상태(CREATED, IN_PROGRESS, SUCCEEDED, FAILED, TIMED_OUT, CANCELED)
  - 생성 타임스탬프
  - 마지막 업데이트 타임스탬프
- IN_PROGRESS 상태에 대한 진행 표시기:
  - 애니메이션 진행 표시
  - 생성 이후 경과 시간
- 완료된 명령 정보:
  - 최종 상태(SUCCEEDED/FAILED)
  - 실행 기간
  - 상태 이유(제공된 경우)
  - 완료 타임스탬프
- 색상으로 구분된 상태 표시기:
  - 녹색: SUCCEEDED
  - 노란색: IN_PROGRESS, CREATED
  - 빨간색: FAILED, TIMED_OUT, CANCELED

**명령 기록 보기**:
- 포괄적인 명령 실행 기록
- 필터링 옵션:
  - 디바이스 이름 필터
  - 상태 필터(CREATED, IN_PROGRESS, SUCCEEDED, FAILED, TIMED_OUT, CANCELED)
  - 시간 범위 필터(시작/종료 타임스탬프)
- 페이지네이션 지원:
  - 구성 가능한 페이지 크기(1-100, 기본값 50)
  - 다음 페이지 탐색
  - 총 개수 표시
- 기록 표시에는 다음이 포함됩니다:
  - 명령 이름
  - 대상 디바이스/그룹
  - 실행 상태
  - 생성 시간
  - 완료 시간(해당하는 경우)
  - 실행 기간
- 정보 메시지가 포함된 빈 기록 처리
- 쉽게 스캔할 수 있도록 색상으로 구분된 상태

**명령 취소**:

**명령 취소**:
- 대화형 명령 실행 ID 입력
- 진행하려면 "CANCEL"을 입력해야 하는 안전 확인
- AWS IoT에 취소 요청 제출
- 상태 업데이트 확인(CANCELED)
- 완료된 명령에 대한 거부 처리:
  - 이미 완료된 명령에 대한 명확한 오류 메시지
  - 현재 명령 상태 표시
- 실패 정보 표시:
  - 실패 이유
  - 현재 명령 상태
  - 문제 해결 제안

**IoT Core 스크립트 통합**:

스크립트는 AWS IoT Core 스크립트를 사용하여 디바이스 측 명령 처리를 시뮬레이션하기 위한 포괄적인 통합 지침을 제공합니다:

**Certificate Manager 통합**(`certificate_manager.py`):
- 디바이스 인증서 생성 및 관리
- 인증서-정책 연결
- 인증서-사물 연결
- MQTT 연결을 위한 인증 설정
- 단계별 터미널 설정 지침:
  1. 새 터미널 창 열기(터미널 2)
  2. 워크샵 환경에서 AWS 자격 증명 복사
  3. IoT Core 스크립트 디렉터리로 이동
  4. certificate_manager.py를 실행하여 디바이스 인증 설정

**MQTT Client Explorer 통합**(`mqtt_client_explorer.py`):
- 명령 주제 구독 설정
- 실시간 명령 수신
- 응답 페이로드 게시
- 성공/실패 시뮬레이션
- 단계별 통합 워크플로:
  1. 명령 요청 주제 구독: `$aws/commands/things/<ThingName>/executions/+/request/#`
  2. 실행 ID가 포함된 명령 페이로드 수신
  3. 응답 주제에 실행 결과 게시: `$aws/commands/things/<ThingName>/executions/<ExecutionId>/response/json`
  4. 선택적으로 확인을 위해 accepted/rejected 주제 구독

**디바이스 시뮬레이션 예제**:

스크립트는 디바이스 응답 시뮬레이션을 위한 완전한 예제 페이로드를 제공합니다:

**성공 응답 예제**:
```json
{
  "status": "SUCCEEDED",
  "executionId": "<ExecutionId>",
  "statusReason": "차량 도어가 성공적으로 잠겼습니다",
  "timestamp": 1701518710000
}
```

**실패 응답 예제**:
```json
{
  "status": "FAILED",
  "executionId": "<ExecutionId>",
  "statusReason": "차량을 잠글 수 없음 - 도어 센서 오작동",
  "timestamp": 1701518710000
}
```

**유효한 상태 값**: SUCCEEDED, FAILED, IN_PROGRESS, TIMED_OUT, REJECTED

**MQTT 주제 구조**:

스크립트는 AWS IoT Commands에 대한 완전한 MQTT 주제 구조를 문서화합니다:

**명령 요청 주제**(디바이스가 명령을 수신하기 위해 구독):
```
$aws/commands/things/<ThingName>/executions/<ExecutionId>/request/<PayloadFormat>
$aws/commands/things/<ThingName>/executions/<ExecutionId>/request
```

**명령 응답 주제**(디바이스가 실행 결과를 게시):
```
$aws/commands/things/<ThingName>/executions/<ExecutionId>/response/<PayloadFormat>
```

**응답 수락 주제**(디바이스가 확인을 위해 구독):
```
$aws/commands/things/<ThingName>/executions/<ExecutionId>/response/accepted/<PayloadFormat>
$aws/commands/things/<ThingName>/executions/<ExecutionId>/response/accepted
```

**응답 거부 주제**(디바이스가 거부 알림을 위해 구독):
```
$aws/commands/things/<ThingName>/executions/<ExecutionId>/response/rejected/<PayloadFormat>
$aws/commands/things/<ThingName>/executions/<ExecutionId>/response/rejected
```

**주제 구성 요소 설명**:
- `<ThingName>`: IoT 사물 이름 또는 MQTT 클라이언트 ID
- `<ExecutionId>`: 각 명령 실행에 대한 고유 식별자(모두 구독하려면 `+` 와일드카드 사용)
- `<PayloadFormat>`: 형식 표시기(json, cbor) - JSON/CBOR이 아닌 경우 생략 가능
- 와일드카드 구독: `$aws/commands/things/<ThingName>/executions/+/request/#`

**AWS IoT Test Client 대안**:
- mqtt_client_explorer에 대한 콘솔 기반 대안
- AWS IoT Console → Test → MQTT test client를 통해 액세스
- 명령 주제 구독
- 응답 페이로드 게시
- 로컬 스크립트 없이 빠른 테스트에 유용

**학습 순간**:

스크립트에는 주요 작업 후 자동으로 나타나는 상황별 학습 순간이 포함되어 있습니다:

1. **명령 템플릿이란?** - 첫 번째 템플릿 생성 후 표시
   - 명령 템플릿 목적 및 구조 설명
   - 페이로드 형식 요구 사항 설명
   - 다른 AWS IoT 기능과 비교

2. **Commands vs Device Shadow vs Jobs** - 첫 번째 명령 실행 후 표시
   - 각 기능을 사용할 시기를 보여주는 비교 표
   - Commands: 즉각적인 실시간 디바이스 작업(초)
   - Device Shadow: 원하는 상태 동기화(최종 일관성)
   - Jobs: 장기 실행 작업, 펌웨어 업데이트(분에서 시간)
   - 각 기능에 대한 사용 사례 예제

3. **MQTT 주제 구조** - mqtt_client_explorer 통합을 표시할 때 표시
   - 완전한 주제 패턴 문서
   - 요청/응답 주제 설명
   - 와일드카드 구독 예제
   - 주제 구성 요소 설명

4. **명령 실행 수명 주기** - 명령 상태를 본 후 표시
   - 상태 전환 흐름(CREATED → IN_PROGRESS → SUCCEEDED/FAILED)
   - 시간 초과 처리
   - 취소 동작
   - 모니터링 모범 사례

5. **모범 사례** - 명령 기록을 본 후 표시
   - 명령 명명 규칙
   - 시간 초과 구성 지침
   - 오류 처리 전략
   - 모니터링 및 경고 권장 사항

6. **콘솔 통합** - Console Checkpoint 알림과 함께 표시
   - AWS IoT Console 탐색
   - 명령 템플릿 확인
   - 실행 타임라인 보기
   - CLI 대 Console 비교

**오류 처리**:

스크립트는 사용자 친화적인 메시지와 함께 포괄적인 오류 처리를 구현합니다:

**검증 오류**:
- 명령 이름 검증(길이, 문자, 형식)
- 설명 검증(길이, 내용)
- 페이로드 형식 검증(JSON 스키마, 복잡도)
- 대상 검증(디바이스/그룹 존재)
- 매개변수 검증(유형, 필수 필드)
- 수정 지침이 포함된 명확한 오류 메시지

**AWS API 오류**:
- ResourceNotFoundException: 명령 또는 대상을 찾을 수 없음
- InvalidRequestException: 잘못된 페이로드 또는 매개변수
- ThrottlingException: 재시도 지침과 함께 속도 제한 초과
- UnauthorizedException: 권한 부족
- 속도 제한을 위한 지수 백오프
- 일시적 오류에 대한 자동 재시도(최대 3회 시도)
- 문제 해결 제안이 포함된 상세한 오류 메시지

**네트워크 오류**:
- 연결 문제 감지
- AWS 자격 증명 확인 지침
- 리전 구성 확인
- 사용자 프롬프트가 포함된 재시도 옵션

**상태 오류**:
- 완료된 명령 취소
- 사용 중인 템플릿 삭제
- 잘못된 상태 전환
- 현재 상태에 대한 명확한 설명

**디버그 모드**:
- 매개변수와 함께 모든 AWS SDK(boto3) API 호출 표시
- JSON 형식의 완전한 API 응답 표시
- 전체 스택 추적이 포함된 상세한 오류 정보 제공
- AWS API 문제 해결 및 학습에 도움
- 스크립트 실행 중 켜기/끄기 전환

**성능 특성**:
- **네이티브 boto3 통합**: 더 나은 성능을 위한 직접 AWS SDK 호출
- **속도 제한**: AWS IoT Commands API 제한 준수
- **효율적인 페이지네이션**: 대규모 명령 목록 및 기록 처리
- **메모리 관리**: 효율적인 JSON 파싱 및 리소스 정리
- **오류 복구**: 지수 백오프를 통한 자동 재시도

**교육 초점**:
- 템플릿 생성부터 실행까지의 완전한 명령 수명 주기
- 실시간 명령 전달 및 승인
- IoT Core 스크립트를 사용한 디바이스 시뮬레이션
- MQTT 주제 구조 및 메시지 흐름
- Commands vs Shadow vs Jobs 결정 지침
- 프로덕션 배포 모범 사례

**문제 해결 가이드**:

**일반적인 문제 및 해결책**:

1. **디바이스가 명령을 수신하지 못함**
   - 디바이스가 명령 요청 주제를 구독했는지 확인
   - MQTT 연결 상태 확인
   - 인증서 및 정책 권한 확인
   - 사물 이름이 대상과 일치하는지 확인
   - 명령을 실행하기 전에 디바이스 시뮬레이터가 실행 중인지 확인

2. **템플릿 검증 오류**
   - JSON 스키마 구문 확인
   - 페이로드 형식 복잡도 확인(최대 10KB)
   - 필수 필드가 정의되었는지 확인
   - 매개변수 유형 및 제약 조건 검증

3. **명령 실행 실패**
   - 대상 디바이스/그룹이 존재하는지 확인
   - AWS IoT Commands에 대한 IAM 권한 확인
   - AWS 리전 구성 확인
   - 명령 시간 초과 설정 검토

4. **상태가 업데이트되지 않음**
   - 디바이스가 올바른 주제에 응답을 게시했는지 확인
   - 응답 페이로드 형식 확인
   - 실행 ID가 일치하는지 확인
   - 오류에 대한 디바이스 로그 검토

5. **취소 실패**
   - 명령이 이미 완료되지 않았는지 확인
   - 명령 실행 상태 확인
   - 취소에 대한 IAM 권한 확인
   - 현재 명령 상태 검토

**통합 워크플로**(올바른 순서):

⚠️ **중요**: 명령을 실행하기 전에 디바이스 시뮬레이터가 실행 중이고 명령 주제를 구독해야 합니다. 명령은 기본적으로 임시적입니다 - 명령이 게시될 때 디바이스가 수신 대기하지 않으면 손실됩니다.

1. **먼저 터미널 2 열기** - AWS 자격 증명 복사
2. IoT Core 스크립트 디렉터리로 이동
3. `certificate_manager.py`를 실행하여 디바이스 인증 설정
4. `mqtt_client_explorer.py`를 실행하여 명령 주제 구독
5. **디바이스 시뮬레이터가 준비되었는지 확인** - "명령 주제 구독됨"이 표시되어야 함
6. **이제 터미널 1 열기** - `manage_commands.py` 실행
7. 명령 템플릿 생성
8. 디바이스를 대상으로 명령 실행
9. **디바이스 시뮬레이터**(터미널 2)가 명령을 수신하고 페이로드 표시
10. **디바이스 시뮬레이터**가 응답 주제에 승인 게시
11. 터미널 1로 돌아가서 업데이트된 명령 상태 보기

**이 순서가 중요한 이유**: 영구 세션이 활성화되지 않으면 MQTT 메시지가 오프라인 디바이스에 대해 대기열에 추가되지 않습니다. AWS IoT가 명령을 게시할 때 디바이스가 명령 주제를 적극적으로 구독해야 하며, 그렇지 않으면 명령이 전달되지 않습니다.

**사용 사례**:

**플릿 전체 긴급 명령**:
- 지역의 모든 차량에 긴급 정지 명령 전송
- 전체 플릿에 걸쳐 안전 리콜 실행
- 보안 위협에 대한 응답 조정
- 실시간 플릿 전체 구성 업데이트

**원격 진단 및 제어**:
- 고객 지원을 위해 원격으로 차량 잠금/잠금 해제
- 고객 도착 전 기후 설정 조정
- 차량 위치 지원을 위해 경적 활성화
- 요청 시 진단 데이터 수집

**프로덕션 배포 패턴**:
- 명령 템플릿 버전 관리 및 관리
- 다중 리전 명령 실행
- 명령 실행 모니터링 및 경고
- 플릿 관리 시스템과의 통합
- 규정 준수 및 감사 로깅

**Commands vs Device Shadow vs Jobs 결정 가이드**:

**Commands** 사용 시기:
- 즉각적인 조치 필요(초 단위 응답 시간)
- 실시간 디바이스 제어 필요
- 빠른 승인 예상
- 디바이스가 온라인 상태여야 함
- 예: 잠금/잠금 해제, 경적 활성화, 긴급 정지

**Device Shadow** 사용 시기:
- 원하는 상태 동기화 필요
- 오프라인 디바이스 지원 필요
- 최종 일관성 허용
- 상태 지속성 중요
- 예: 온도 설정, 구성, 원하는 상태

**Jobs** 사용 시기:
- 장기 실행 작업 필요(분에서 시간)
- 펌웨어 업데이트 필요
- 배치 디바이스 관리
- 진행 상황 추적 중요
- 예: 펌웨어 업데이트, 인증서 교체, 대량 구성

**AWS 서비스 통합**:
- **AWS IoT Core**: 명령 템플릿 스토리지 및 실행
- **AWS IoT Device Management**: 플릿 관리 및 타겟팅
- **AWS Identity and Access Management(IAM)**: 권한 및 정책
- **Amazon CloudWatch**: 모니터링 및 로깅(선택 사항)

**보안 고려 사항**:
- 명령 작업에 대한 IAM 권한
- 인증서 기반 디바이스 인증
- MQTT 주제에 대한 정책 기반 권한 부여
- 전송 중 명령 페이로드 암호화
- 규정 준수를 위한 감사 로깅

**비용 최적화**:
- 명령은 실행당 요금이 부과됩니다
- 명령 템플릿에 대한 스토리지 비용 없음
- 효율적인 타겟팅으로 불필요한 실행 감소
- 사용 패턴에 대한 명령 기록 모니터링
- 비용 효율성을 위한 배치 작업 고려
