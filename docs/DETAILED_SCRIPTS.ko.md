# 상세 스크립트 문서

이 문서는 AWS IoT Device Management 프로젝트의 각 스크립트에 대한 포괄적인 정보를 제공합니다. 모든 스크립트는 최적의 성능과 안정성을 위해 네이티브 AWS SDK(boto3)를 사용합니다.

## 핵심 스크립트

### scripts/provision_script.py
**목적**: 네이티브 boto3 API를 사용한 디바이스 관리 시나리오를 위한 완전한 AWS IoT 인프라 프로비저닝.

**기능**:
- 검색 가능한 속성(customerId, country, manufacturingDate)을 가진 사물 유형 생성
- VIN 스타일 명명(Vehicle-VIN-001)으로 수천 개의 IoT 디바이스 프로비저닝
- 펌웨어 패키지를 위한 버전 관리 기능이 있는 Amazon S3 스토리지 설정
- 여러 버전의 AWS IoT 소프트웨어 패키지 생성
- 디바이스 쿼리를 위한 AWS IoT Fleet Indexing 구성
- 안전한 작업을 위한 AWS Identity and Access Management(IAM) 역할 설정
- 국가별 정적 사물 그룹 생성(Fleet 명명 규칙)
- **병렬 처리**: 더 빠른 프로비저닝을 위한 동시 작업
- **향상된 오류 처리**: 강력한 boto3 예외 처리

**대화형 입력**:
1. 사물 유형(기본값: SedanVehicle,SUVVehicle,TruckVehicle)
2. 패키지 버전(기본값: 1.0.0,1.1.0)
3. 대륙 선택(1-7)
4. 국가(개수 또는 특정 코드)
5. 디바이스 개수(기본값: 100)

**교육적 일시 정지**: IoT 개념을 설명하는 8개의 학습 순간

**속도 제한**: 지능형 AWS API 스로틀링(사물은 80 TPS, 사물 유형은 8 TPS)

**성능**: 디버그 모드가 아닐 때는 병렬 실행, 디버그 모드에서는 깔끔한 출력을 위해 순차 실행

---

### scripts/cleanup_script.py
**목적**: 네이티브 boto3 API를 사용하여 지속적인 비용을 피하기 위한 AWS IoT 리소스의 안전한 제거.

**정리 옵션**:
1. **모든 리소스** - 완전한 인프라 정리
2. **사물만** - 디바이스 제거하지만 인프라는 유지
3. **사물 그룹만** - 그룹화 제거하지만 디바이스는 유지

**기능**:
- **네이티브 boto3 구현**: CLI 종속성 없음, 더 나은 오류 처리
- 지능형 속도 제한이 있는 **병렬 처리**
- **향상된 S3 정리**: 페이지네이터를 사용한 적절한 버전 관리 객체 삭제
- 정적 그룹과 동적 그룹을 자동으로 구분
- 사물 유형 사용 중단 처리(5분 대기)
- 상태 모니터링과 함께 AWS IoT 작업 취소 및 삭제
- 포괄적인 IAM 역할 및 정책 정리
- Fleet Indexing 구성 비활성화
- **섀도우 정리**: 클래식 섀도우와 $package 섀도우 모두 제거
- **주체 분리**: 인증서 및 정책을 적절하게 분리

**안전성**: 확인을 위해 "DELETE"를 입력해야 함

**성능**: AWS API 제한을 준수하는 병렬 실행(사물 80 TPS, 동적 그룹 4 TPS)

---

### scripts/create_job.py
**목적**: 네이티브 boto3 API를 사용한 OTA 펌웨어 업데이트를 위한 AWS IoT 작업 생성.

**기능**:
- **네이티브 boto3 구현**: 더 나은 성능을 위한 직접 API 호출
- 대화형 사물 그룹 선택(단일 또는 다중)
- ARN 해결이 포함된 패키지 버전 선택
- 연속 작업 구성(새 디바이스 자동 포함)
- 사전 서명된 URL 구성(1시간 만료)
- 다중 그룹 타겟팅 지원
- **향상된 작업 유형**: OTA 및 사용자 정의 작업 유형 모두 지원
- **고급 구성**: 롤아웃 정책, 중단 기준, 시간 초과 설정

**작업 구성**:
- 타임스탬프가 있는 자동 생성 작업 ID
- AWS IoT 사전 서명된 URL 플레이스홀더
- 리소스에 대한 적절한 ARN 형식
- 포괄적인 작업 문서 구조
- **교육 콘텐츠**: 작업 구성 옵션 설명

---

### scripts/simulate_job_execution.py
**목적**: 네이티브 boto3 API를 사용한 펌웨어 업데이트 중 현실적인 디바이스 동작 시뮬레이션.

**기능**:
- **네이티브 boto3 구현**: IoT Jobs Data API와의 직접 통합
- 사전 서명된 URL을 통한 실제 Amazon S3 아티팩트 다운로드
- **고성능 병렬 실행**(세마포어 제어가 있는 150 TPS)
- 구성 가능한 성공/실패율
- **가시적인 계획 준비** - 각 디바이스에 성공/실패 상태가 할당되는 것을 표시
- **사용자 확인** - 계획 준비 후 진행 여부를 묻습니다
- **작업 가시성** - 각 디바이스의 다운로드 진행 상황 및 작업 상태 업데이트 표시
- **향상된 오류 처리**: 강력한 boto3 예외 관리
- 상세한 보고가 포함된 진행 상황 추적
- **깔끔한 JSON 형식**: 적절하게 형식화된 작업 문서 표시

**프로세스 흐름**:
1. 네이티브 API를 사용하여 활성 작업 스캔
2. 대기 중인 실행 가져오기(QUEUED/IN_PROGRESS)
3. **실행 계획 준비** - 디바이스 할당을 표시하고 확인 요청
4. Amazon S3에서 실제 펌웨어 다운로드(디바이스별 진행 상황 표시)
5. IoT Jobs Data API를 사용하여 작업 실행 상태 업데이트
6. 포괄적인 성공/실패 통계 보고

**성능 개선**:
- **병렬 처리**: 디버그 모드가 아닐 때 동시 실행
- **속도 제한**: 세마포어 기반 지능형 스로틀링
- **메모리 효율성**: 대용량 펌웨어 파일을 위한 스트리밍 다운로드

**가시성 개선**:
- 계획 준비 표시: `[1/100] Vehicle-VIN-001 -> SUCCESS`
- 다운로드 진행 상황 표시: `Vehicle-VIN-001: Downloading firmware from S3...`
- 파일 크기 확인: `Vehicle-VIN-001: Downloaded 2.1KB firmware`
- 상태 업데이트 표시: `Vehicle-VIN-001: Job execution SUCCEEDED`

---

### scripts/explore_jobs.py
**목적**: 네이티브 boto3 API를 사용한 모니터링 및 문제 해결을 위한 AWS IoT 작업의 대화형 탐색.

**메뉴 옵션**:
1. **모든 작업 나열** - 병렬 스캔을 통한 모든 상태의 개요
2. **특정 작업 탐색** - 깔끔한 JSON 형식의 상세한 작업 구성
3. **작업 실행 탐색** - IoT Jobs Data API를 사용한 개별 디바이스 진행 상황
4. **작업 실행 나열** - 병렬 상태 확인이 있는 작업의 모든 실행

**기능**:
- **네이티브 boto3 구현**: 더 나은 성능을 위한 직접 API 통합
- **병렬 작업 스캔**: 모든 작업 상태에 걸친 동시 상태 확인
- **깔끔한 JSON 표시**: 이스케이프 문자 없이 적절하게 형식화된 작업 문서
- 색상으로 구분된 상태 표시기
- 사용 가능한 작업 목록이 있는 대화형 작업 선택
- 상세한 사전 서명된 URL 구성 표시
- 색상 코딩이 있는 실행 요약 통계
- **향상된 오류 처리**: 강력한 boto3 예외 관리
- 연속 탐색 루프

**성능 개선**:
- **병렬 처리**: 디버그 모드가 아닐 때 동시 작업
- **지능형 페이지네이션**: 대규모 작업 목록의 효율적인 처리
- **속도 제한**: 세마포어를 사용한 적절한 API 스로틀링

---

### scripts/manage_packages.py
**목적**: 네이티브 boto3 API를 사용한 AWS IoT 소프트웨어 패키지, 디바이스 추적 및 버전 롤백의 포괄적인 관리.

**작업**:
1. **패키지 생성** - 새 소프트웨어 패키지 컨테이너 생성
2. **버전 생성** - S3 펌웨어 업로드 및 게시로 버전 추가(학습 순간 포함)
3. **패키지 나열** - 대화형 설명 옵션이 있는 패키지 표시
4. **패키지 설명** - 버전 탐색이 있는 패키지 세부 정보 표시
5. **버전 설명** - 특정 버전 세부 정보 및 Amazon S3 아티팩트 표시
6. **구성 확인** - 패키지 구성 상태 및 IAM 역할 보기
7. **구성 활성화** - IAM 역할 생성으로 자동 섀도우 업데이트 활성화
8. **구성 비활성화** - 자동 섀도우 업데이트 비활성화
9. **디바이스 버전 확인** - 특정 디바이스의 $package 섀도우 검사(다중 디바이스 지원)
10. **버전 되돌리기** - Fleet Indexing을 사용한 플릿 전체 버전 롤백

**주요 기능**:
- **Amazon S3 통합**: 버전 관리가 있는 자동 펌웨어 업로드
- **대화형 탐색**: 나열, 설명 및 버전 작업 간의 원활한 흐름
- **패키지 구성 관리**: Jobs-to-Shadow 통합 제어
- **디바이스 추적**: 개별 디바이스 패키지 버전 검사
- **플릿 롤백**: Fleet Indexing 쿼리를 사용한 버전 되돌리기
- **교육적 접근**: 워크플로 전반에 걸친 학습 순간
- **IAM 역할 관리**: 패키지 구성을 위한 자동 역할 생성

**패키지 구성**:
- **상태 확인**: 활성화/비활성화 상태 및 IAM 역할 ARN 표시
- **활성화**: $package 섀도우 권한이 있는 IoTPackageConfigRole 생성
- **비활성화**: 작업 완료 시 자동 섀도우 업데이트 중지
- **교육적**: Jobs-to-Shadow 통합 및 IAM 요구 사항 설명

**디바이스 버전 추적**:
- **다중 디바이스 지원**: 여러 디바이스를 순차적으로 확인
- **$package 섀도우 검사**: 현재 펌웨어 버전 및 메타데이터 표시
- **타임스탬프 표시**: 각 패키지의 마지막 업데이트 정보
- **오류 처리**: 누락된 디바이스 또는 섀도우에 대한 명확한 메시지

**버전 롤백**:
- **Fleet Indexing 쿼리**: 사물 유형 및 버전별로 디바이스 찾기
- **디바이스 목록 미리보기**: 되돌릴 디바이스 표시(처음 10개 + 개수)
- **확인 필요**: 섀도우 업데이트를 진행하려면 'REVERT' 입력
- **개별 디바이스 상태**: 디바이스별 되돌리기 성공/실패 표시
- **진행 상황 추적**: 성공 개수가 있는 실시간 업데이트 상태
- **교육적**: 롤백 개념 및 섀도우 관리 설명

**롤백 가시성**:
- 디바이스 미리보기: `1. Vehicle-VIN-001`, `2. Vehicle-VIN-002`, `... 및 90개 이상의 디바이스`
- 개별 결과: `Vehicle-VIN-001: Reverted to version 1.0.0`
- 실패한 시도: `Vehicle-VIN-002: Failed to revert`

**학습 초점**:
- 생성부터 롤백까지의 완전한 펌웨어 수명 주기
- 패키지 구성 및 자동 섀도우 업데이트
- 디바이스 인벤토리 관리 및 추적
- 버전 관리 작업을 위한 Fleet Indexing

---

### scripts/manage_dynamic_groups.py
**목적**: 네이티브 boto3 API를 사용한 Fleet Indexing 검증이 있는 동적 사물 그룹의 포괄적인 관리.

**작업**:
1. **동적 그룹 생성** - 두 가지 생성 방법:
   - **안내 마법사**: 대화형 기준 선택
   - **사용자 정의 쿼리**: Fleet Indexing 쿼리 직접 입력
2. **동적 그룹 나열** - 멤버 수 및 쿼리와 함께 모든 그룹 표시
3. **동적 그룹 삭제** - 확인이 있는 안전한 삭제
4. **쿼리 테스트** - 사용자 정의 Fleet Indexing 쿼리 검증

**생성 방법**:
- **안내 마법사**(모두 선택 사항):
  - 국가: 단일 또는 다중(예: US,CA,MX)
  - 사물 유형: 차량 카테고리(예: SedanVehicle)
  - 버전: 단일 또는 다중(예: 1.0.0,1.1.0)
  - 배터리 수준: 비교(예: >50, <30, =75)
- **사용자 정의 쿼리**: Fleet Indexing 쿼리 문자열 직접 입력

**기능**:
- **이중 생성 모드**: 안내 마법사 또는 사용자 정의 쿼리 입력
- 스마트 그룹 명명(자동 생성 또는 사용자 정의)
- Fleet Indexing 쿼리 구성 및 검증
- **실시간 디바이스 매칭 미리보기**(생성 전에 일치하는 디바이스 표시)
- 기존 그룹의 멤버 수 표시
- 확인 프롬프트가 있는 안전한 삭제
- 사용자 정의 쿼리 테스트 기능
- 쿼리 검증으로 빈 그룹 생성 방지

**쿼리 예제**:
- 단일 기준: `thingTypeName:SedanVehicle AND attributes.country:US`
- 다중 기준: `thingTypeName:SedanVehicle AND attributes.country:(US OR CA) AND shadow.reported.batteryStatus:[50 TO *]`
- 패키지 버전: `shadow.name.\$package.reported.SedanVehicle.version:1.1.0`
- 사용자 정의 복잡: `(thingTypeName:SedanVehicle OR thingTypeName:SUVVehicle) AND attributes.country:US AND shadow.reported.batteryStatus:[30 TO 80]`

---

### scripts/check_syntax.py
**목적**: CI/CD 파이프라인을 위한 게시 전 구문 검증.

**확인**:
- 모든 스크립트의 Python 구문 검증
- 가져오기 가용성 확인
- requirements.txt 검증
- 종속성 나열

**사용법**: GitHub Actions 워크플로에 의해 자동으로 실행

---

## 스크립트 종속성

### 필수 Python 패키지
- `boto3>=1.40.27` - AWS SDK for Python(패키지 아티팩트 지원을 위한 최신 버전)
- `colorama>=0.4.4` - 터미널 색상
- `requests>=2.25.1` - Amazon S3 다운로드를 위한 HTTP 요청

### 사용되는 AWS 서비스
- **AWS IoT Core** - 사물 관리, 작업, 섀도우
- **AWS IoT Device Management** - 소프트웨어 패키지, Fleet Indexing
- **Amazon S3** - 버전 관리가 있는 펌웨어 스토리지
- **AWS Identity and Access Management (IAM)** - 안전한 액세스를 위한 역할 및 정책

### AWS 자격 증명 요구 사항
- 다음을 통해 구성된 자격 증명:
  - `aws configure`(AWS CLI)
  - 환경 변수(AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
  - IAM 역할(EC2/Lambda 실행용)
  - AWS 자격 증명 파일
- AWS IoT, Amazon S3 및 IAM 작업에 대한 적절한 IAM 권한
- 리전 구성(AWS_DEFAULT_REGION 환경 변수 또는 자격 증명)

## 교육 기능

### 학습 순간
각 스크립트에는 다음을 설명하는 교육적 일시 정지가 포함됩니다:
- AWS IoT 개념 및 아키텍처
- 디바이스 관리 모범 사례
- 보안 고려 사항
- 확장성 패턴

### 진행 상황 추적
- 실시간 작업 상태
- 성공/실패 개수
- 성능 메트릭(TPS, 기간)
- 읽기 쉬운 색상 코딩된 출력

### 디버그 모드
모든 스크립트에서 사용 가능:
- 매개변수가 있는 모든 AWS SDK(boto3) API 호출 표시
- JSON 형식의 전체 API 응답 표시
- 전체 스택 추적이 있는 상세한 오류 정보 제공
- **순차 처리**: 깔끔한 디버그 출력을 위해 작업을 순차적으로 실행
- AWS API 문제 해결 및 학습에 도움

## 성능 특성

### 속도 제한
스크립트는 AWS API 제한을 준수합니다:
- 사물 작업: 80 TPS(100 TPS 제한)
- 사물 유형: 8 TPS(10 TPS 제한)
- 동적 그룹: 4 TPS(5 TPS 제한)
- 작업 실행: 150 TPS(200 TPS 제한)
- 패키지 작업: 8 TPS(10 TPS 제한)

### 병렬 처리
- **네이티브 boto3 통합**: 더 나은 성능을 위한 직접 AWS SDK 호출
- 동시 작업을 위한 ThreadPoolExecutor(디버그 모드가 아닐 때)
- **지능형 속도 제한**: AWS API 제한을 준수하는 세마포어
- **스레드 안전 진행 상황 추적**: 동시 작업 모니터링
- **향상된 오류 처리**: 강력한 boto3 ClientError 예외 관리
- **디버그 모드 재정의**: 깔끔한 출력을 위한 디버그 모드의 순차 처리

### 메모리 관리
- 대용량 파일을 위한 스트리밍 다운로드
- 임시 파일 정리
- 효율적인 JSON 파싱
- 종료 시 리소스 정리
