# 詳細なスクリプトドキュメント

このドキュメントは、AWS IoT Device Managementプロジェクトの各スクリプトに関する包括的な情報を提供します。すべてのスクリプトは、最適なパフォーマンスと信頼性のためにネイティブAWS SDK（boto3）を使用しています。

## コアスクリプト

### scripts/provision_script.py
**目的**: ネイティブboto3 APIを使用したデバイス管理シナリオのための完全なAWS IoTインフラストラクチャプロビジョニング。

**機能**:
- 検索可能な属性（customerId、country、manufacturingDate）を持つモノタイプを作成
- VINスタイルの命名（Vehicle-VIN-001）で数千のIoTデバイスをプロビジョニング
- ファームウェアパッケージ用のバージョニング付きAmazon S3ストレージをセットアップ
- 複数のバージョンを持つAWS IoTソフトウェアパッケージを作成
- デバイスクエリ用のAWS IoT Fleet Indexingを構成
- 安全な操作のためのAWS Identity and Access Management（IAM）ロールを確立
- 国別の静的モノグループを作成（Fleet命名規則）
- **並列処理**: より高速なプロビジョニングのための同時操作
- **強化されたエラー処理**: 堅牢なboto3例外処理

**インタラクティブ入力**:
1. モノタイプ（デフォルト: SedanVehicle,SUVVehicle,TruckVehicle）
2. パッケージバージョン（デフォルト: 1.0.0,1.1.0）
3. 大陸選択（1-7）
4. 国（カウントまたは特定のコード）
5. デバイス数（デフォルト: 100）

**教育的な一時停止**: IoTコンセプトを説明する8つの学習モーメント

**コマンドラインパラメータ**:
- `--things-prefix PREFIX` - モノ名のカスタムプレフィックス（デフォルト: "Vehicle-VIN-"）
  - 1〜20文字である必要があります
  - 英数字、ハイフン、アンダースコア、コロンのみ
  - 例: `--things-prefix "Fleet-Device-"` は Fleet-Device-001、Fleet-Device-002 などを作成します

**リソースタグ付け動作**:
作成されたすべてのリソースには自動的に以下のタグが付けられます:
- `workshop=learning-aws-iot-dm-basics` - ワークショップリソースを識別
- `creation-date=YYYY-MM-DD` - 追跡用のタイムスタンプ

**タグ付けされるリソース**:
- モノタイプ
- モノグループ（静的グループ）
- ソフトウェアパッケージ
- ソフトウェアパッケージバージョン
- ジョブ
- S3バケット
- IAMロール

**タグ失敗の処理**:
- タグ付けの失敗はリソース作成を妨げません
- スクリプトは失敗したタグに対して警告を出して続行します
- サマリーレポートにはタグのないリソースが表示されます
- クリーンアップスクリプトはフォールバックとして命名パターンを使用します

**教育的な一時停止**: IoTコンセプトを説明する8つの学習モーメント

**レート制限**: インテリジェントなAWS APIスロットリング（モノは80 TPS、モノタイプは8 TPS）

**パフォーマンス**: デバッグモードでない場合は並列実行、デバッグモードではクリーンな出力のために順次実行

**リソースタグ付け**:
- **自動ワークショップタグ**: すべてのタグ付け可能なリソースに `workshop=learning-aws-iot-dm-basics` タグが付けられます
- **サポートされるリソース**: モノタイプ、モノグループ、パッケージ、ジョブ、S3バケット、IAMロール
- **タグ付け不可能なリソース**: モノ、証明書、Shadowは命名規則に依存します
- **タグ失敗の処理**: グレースフルデグラデーション - タグ付けが失敗してもリソース作成を続行します
- **クリーンアップ統合**: タグはクリーンアップ操作中の安全な識別を可能にします

**モノの命名規則**:
- **--things-prefix パラメータ**: モノ名の設定可能なプレフィックス（デフォルト: "Vehicle-VIN-"）
- **命名パターン**: `{prefix}{sequential_number}`（例: Vehicle-VIN-001、Vehicle-VIN-002）
- **連番**: ゼロパディングされた3桁の数字（001-999）
- **プレフィックス検証**: 英数字、ハイフン、アンダースコア、コロンのみ; 最大20文字
- **レガシーサポート**: 古い `vehicle-{country}-{type}-{index}` パターンも認識します
- **クリーンアップ統合**: 命名パターンによりタグ付け不可能なリソースの識別が可能になります

**使用例**:
```bash
# デフォルトのプレフィックスを使用（Vehicle-VIN-）
python scripts/provision_script.py

# カスタムプレフィックスを使用
python scripts/provision_script.py --things-prefix "Fleet-Device-"

# カスタムプレフィックスは次を作成: Fleet-Device-001、Fleet-Device-002 など
```

---

### scripts/cleanup_script.py
**目的**: ネイティブboto3 APIを使用したインテリジェントなリソース識別による、継続的なコストを回避するためのAWS IoTリソースの安全な削除。

**クリーンアップオプション**:
1. **すべてのリソース** - 完全なインフラストラクチャクリーンアップ
2. **モノのみ** - デバイスを削除するがインフラストラクチャは保持
3. **モノグループのみ** - グループ化を削除するがデバイスは保持

**コマンドラインパラメータ**:
- `--things-prefix PREFIX` - モノ識別用のカスタムプレフィックス（デフォルト: "Vehicle-VIN-"）
  - プロビジョニング時に使用したプレフィックスと一致する必要があります
  - カスタム命名パターンを持つモノの識別に使用されます
  - 例: `--things-prefix "Fleet-Device-"` は Fleet-Device-001、Fleet-Device-002 などを識別します
- `--dry-run` - 変更を加えずに削除されるものをプレビュー
  - 削除されるすべてのリソースを表示します
  - 各リソースの識別方法を表示します
  - 実際の削除は実行されません
  - 実行前にクリーンアップの範囲を確認するのに便利です

**リソース識別方法**:

クリーンアップスクリプトは、ワークショップリソースを安全に識別するために3層の識別システムを使用します:

**1. タグベースの識別（最優先）**:
- `workshop=learning-aws-iot-dm-basics` タグをチェックします
- タグ付けで作成されたリソースに対して最も信頼性の高い方法です
- 対象: モノタイプ、モノグループ、パッケージ、パッケージバージョン、ジョブ、S3バケット、IAMロール

**2. 命名パターン識別（フォールバック）**:
- リソース名をワークショップパターンと照合します
- タグが存在しない、またはサポートされていない場合に使用されます
- パターンには以下が含まれます:
  - モノ: `Vehicle-VIN-###` またはカスタムプレフィックスパターン（例: `Fleet-Device-###`）
  - モノタイプ: `SedanVehicle`、`SUVVehicle`、`TruckVehicle`
  - モノグループ: `Fleet-*`（静的グループ）
  - 動的グループ: `DynamicGroup-*`
  - パッケージ: `SedanVehicle-Package`、`SUVVehicle-Package`、`TruckVehicle-Package`
  - ジョブ: `OTA-Job-*`、`Command-Job-*`
  - S3バケット: `iot-dm-workshop-*`
  - IAMロール: `IoTJobsRole`、`IoTPackageConfigRole`

**3. 関連付けベースの識別（タグ付け不可能なリソース用）**:
- 直接タグ付けできないリソースに使用されます
- 証明書: ワークショップのモノへのアタッチメントで識別されます
- Shadow: ワークショップのモノへの所属で識別されます
- 依存リソースの完全なクリーンアップを保証します

**識別プロセス**:
1. 各リソースについて、まずタグをチェックします
2. ワークショップタグが見つからない場合、命名パターンをチェックします
3. パターンマッチがない場合、関連付けをチェックします（証明書/Shadow用）
4. 識別方法が成功しない場合、リソースはスキップされます
5. デバッグモードでは、各リソースを識別した方法が表示されます

**機能**:
- **ネイティブboto3実装**: CLI依存関係なし、より良いエラー処理
- **インテリジェントなリソース識別**: 3層システム（タグ → 命名 → 関連付け）
- **ドライランモード**: 変更を加えずに削除をプレビュー
- **カスタムプレフィックスサポート**: カスタム命名パターンを持つモノを識別
- インテリジェントなレート制限を持つ**並列処理**
- **強化されたS3クリーンアップ**: ページネーターを使用した適切なバージョン管理されたオブジェクトの削除
- 静的グループと動的グループを自動的に区別
- モノタイプの非推奨化を処理（5分待機）
- ステータス監視付きでAWS IoT Jobsをキャンセルおよび削除
- 包括的なIAMロールとポリシーのクリーンアップ
- Fleet Indexing構成を無効化
- **Shadowクリーンアップ**: クラシックと$package shadowの両方を削除
- **プリンシパルのデタッチ**: 証明書とポリシーを適切にデタッチ
- **包括的なレポート**: 削除およびスキップされたリソースをカウント付きで表示

**安全機能**:
- 確認のために「DELETE」と入力する必要があります（ドライランモードを除く）
- 非ワークショップリソースを自動的にスキップします
- 削除されるものの概要を表示します
- 実際の削除前の検証用ドライランモード
- 個々のリソースが失敗してもクリーンアップを続行するエラー処理

**ドライランモードの例**:
```bash
python scripts/cleanup_script.py --dry-run
```
出力内容:
- 削除されるリソース（識別方法付き）
- スキップされるリソース（非ワークショップリソース）
- リソースタイプ別の合計カウント
- 実際の削除は実行されません

**カスタムプレフィックスの例**:
```bash
python scripts/cleanup_script.py --things-prefix "Fleet-Device-"
```
識別および削除:
- Fleet-Device-### パターンに一致するモノ
- 関連する証明書とShadow
- その他のワークショップリソース（タグまたはパターンで識別）

**パフォーマンス**: AWS APIリミットを尊重した並列実行（モノ80 TPS、動的グループ4 TPS）

**タグベースのクリーンアップ例**:
```
モノタイプをスキャン中...
3つのモノタイプが見つかりました
  ✓ SedanVehicle（タグで識別: workshop=learning-aws-iot-dm-basics）
  ✓ SUVVehicle（タグで識別: workshop=learning-aws-iot-dm-basics）
  ✓ TruckVehicle（タグで識別: workshop=learning-aws-iot-dm-basics）

モノグループをスキャン中...
5つのモノグループが見つかりました
  ✓ fleet-US（タグで識別: workshop=learning-aws-iot-dm-basics）
  ✓ fleet-CA（タグで識別: workshop=learning-aws-iot-dm-basics）
  ✗ production-fleet（スキップ - ワークショップタグなし）
```

**命名ベースのクリーンアップ例**:
```
モノをスキャン中...
102個のモノが見つかりました
  ✓ Vehicle-VIN-001（命名パターンで識別: Vehicle-VIN-###）
  ✓ Vehicle-VIN-002（命名パターンで識別: Vehicle-VIN-###）
  ✓ vehicle-US-sedan-1（レガシーパターンで識別）
  ✗ production-device-001（スキップ - パターンマッチなし）
```

**関連付けベースのクリーンアップ例**:
```
モノを処理中: Vehicle-VIN-001
  ✓ クラシックShadow（ワークショップのモノとの関連付けで識別）
  ✓ $package Shadow（ワークショップのモノとの関連付けで識別）
  ✓ 証明書 abc123（ワークショップのモノとの関連付けで識別）
  
モノを処理中: production-device-001
  ✗ 証明書 xyz789（スキップ - 非ワークショップのモノにアタッチ）
```

**クリーンアップサマリー出力**:
```
クリーンアップサマリー:
================
削除されたリソース:
  - IoTモノ: 100
  - モノグループ: 5
  - モノタイプ: 3
  - パッケージ: 3
  - ジョブ: 2
  - S3バケット: 1
  - IAMロール: 2
  合計: 116

スキップされたリソース:
  - IoTモノ: 2（非ワークショップリソース）
  - モノグループ: 1（非ワークショップリソース）
  合計: 3

実行時間: 45.3秒
```

**クリーンアップ問題のトラブルシューティング**:

**問題: リソースが削除されない**

症状:
- クリーンアップスクリプトが削除されるべきリソースをスキップする
- 「スキップされたリソース」のカウントが予想より高い
- クリーンアップ後に特定のリソースが残る

解決策:
1. **モノプレフィックスの一致を確認**:
   ```bash
   # プロビジョニング時にカスタムプレフィックスを使用した場合:
   python scripts/provision_script.py --things-prefix "MyPrefix-"
   
   # クリーンアップ時に同じプレフィックスを使用する必要があります:
   python scripts/cleanup_script.py --things-prefix "MyPrefix-"
   ```

2. **リソースタグを確認**:
   - デバッグモードでクリーンアップを実行して識別方法を確認
   - タグ付け可能なリソースに `workshop=learning-aws-iot-dm-basics` タグがあることを確認
   - AWSコンソール → IoT Core → リソースタグを確認

3. **命名パターンを確認**:
   - モノは次と一致する必要があります: `{prefix}###` または `vehicle-{country}-{type}-{index}`
   - グループは次と一致する必要があります: `fleet-{country}` または「workshop」を含む
   - ドライランモードを使用して識別されるものを確認

4. **最初にドライランを使用**:
   ```bash
   # 削除されるものをプレビュー
   python scripts/cleanup_script.py --dry-run
   
   # スキップされたリソースの出力を確認
   # デバッグモードで識別方法を確認
   ```

**問題: プロビジョニング中のタグ適用失敗**

症状:
- プロビジョンスクリプトが「タグの適用に失敗しました」という警告を表示
- リソースは作成されたがワークショップタグがない
- クリーンアップスクリプトが削除されるべきリソースをスキップ

解決策:
1. **IAM権限を確認**:
   - IAMユーザー/ロールにタグ付け権限があることを確認
   - 必要なアクション: `iot:TagResource`、`s3:PutBucketTagging`、`iam:TagRole`

2. **命名規則に依存**:
   - タグのないリソースでも命名パターンで識別可能
   - プロビジョニング中に一貫した命名を確保
   - プロビジョンとクリーンアップで同じ --things-prefix を使用

3. **手動タグ追加**（必要な場合）:
   ```bash
   # AWS CLIを介して手動でタグを追加
   aws iot tag-resource --resource-arn <arn> --tags workshop=learning-aws-iot-dm-basics
   ```

**問題: クリーンアップが誤ったリソースを削除**

症状:
- 非ワークショップリソースが削除対象として識別される
- ドライランが予期しないリソースを表示

解決策:
1. **常に最初にドライランを使用**:
   ```bash
   python scripts/cleanup_script.py --dry-run
   ```

2. **命名パターンを確認**:
   - 本番リソースがワークショップパターンと一致しないことを確認
   - 本番のモノに「Vehicle-VIN-」プレフィックスを使用しない
   - 本番グループに「fleet-」プレフィックスを使用しない

3. **タグの競合を確認**:
   - 本番リソースにワークショップタグがないことを確認
   - AWSアカウントのタグポリシーを確認

**問題: クリーンアップが権限エラーで失敗**

症状:
- 「AccessDeniedException」または「UnauthorizedException」エラー
- 部分的なクリーンアップ完了
- 一部のリソースタイプは削除され、他はスキップされる

解決策:
1. **IAM権限を確認**:
   - README.mdに記載されている必要な権限
   - すべての必要なアクションのIAMポリシーを確認
   - IoT、S3、IAM、Fleet Indexingの権限を確認

2. **リソースポリシーを確認**:
   - S3バケットポリシーが削除をブロックする可能性
   - IAMロールの信頼ポリシーが削除を妨げる可能性
   - リソースレベルのポリシーを確認

3. **デバッグモードを使用**:
   ```bash
   # デバッグで実行して正確なAPIエラーを確認
   python scripts/cleanup_script.py
   # デバッグモードで 'y' と回答
   ```

**問題: クリーンアップに時間がかかりすぎる**

症状:
- クリーンアップが長時間実行される
- 進行が遅いように見える
- タイムアウトエラー

解決策:
1. **予想される期間**:
   - 100個のモノ: 約2〜3分
   - 1000個のモノ: 約15〜20分
   - モノタイプの削除: +5分（必要な非推奨化待機）

2. **レート制限**:
   - スクリプトはAWS APIリミットを自動的に尊重
   - 並列処理がパフォーマンスを最適化
   - デバッグモードは順次実行（遅いが出力が明確）

3. **進行状況を監視**:
   - リアルタイムの進行状況インジケーターを確認
   - AWSコンソールで削除ステータスを確認
   - デバッグモードを使用して各操作を確認

**問題: ドライランが実際のクリーンアップと異なる結果を表示**

症状:
- ドライランが識別するリソースを実際のクリーンアップがスキップ
- モード間で一貫性のない動作

解決策:
1. **リソース状態の変更**:
   - ドライランと実際のクリーンアップの間にリソースが変更される可能性
   - 他のプロセスによってタグが追加/削除される可能性
   - 実際のクリーンアップの直前にドライランを再実行

2. **同時変更**:
   - 他のユーザー/プロセスがリソースを変更している可能性
   - チームとクリーンアップのタイミングを調整
   - 可能な場合はリソースロックを使用

3. **キャッシュの問題**:
   - AWS APIレスポンスが短時間キャッシュされる可能性
   - ドライランと実際のクリーンアップの間に数秒待つ
   - AWSコンソールを更新して現在の状態を確認

**問題: 部分的なクリーンアップ**

症状:
- 一部のリソースは削除され、他は残る
- クリーンアップ中のエラーメッセージ
- 不完全なクリーンアップ結果

解決策:
1. **依存関係の問題**:
   - 一部のリソースは依存関係のため削除に失敗する可能性
   - スクリプトは残りのリソースで続行
   - 特定の失敗についてエラーメッセージを確認
   - スクリプトを再実行して残りのリソースをクリーンアップ

2. **リソースの状態**:
   - モノタイプは削除前に非推奨化する必要があります（5分待機）
   - ジョブは削除前にキャンセルする必要があります
   - S3バケットは削除前に空にする必要があります

3. **クリーンアップを再実行**:
   ```bash
   # 残りのリソースをキャッチするためにクリーンアップを再度実行
   python scripts/cleanup_script.py
   ```

**安全なクリーンアップのベストプラクティス**:

1. **常にドライランから開始**:
   ```bash
   python scripts/cleanup_script.py --dry-run
   ```

2. **モノプレフィックスの一致を確認**:
   - プロビジョニングと同じ --things-prefix を使用
   - チーム参照用にカスタムプレフィックスを文書化

3. **トラブルシューティングにデバッグモードを使用**:
   - 各リソースの識別方法を確認
   - リソースがスキップされる理由を理解
   - タグと命名パターンの一致を確認

4. **チームと調整**:
   - クリーンアップのタイミングを伝達
   - リソースを使用しているアクティブなワークショップがないことを確認
   - クリーンアップ結果を文書化

5. **AWSコンソールを監視**:
   - リソースが予想通りに削除されたことを確認
   - 残りのワークショップリソースを確認
   - 利用可能な場合はCloudWatchログを確認

6. **一貫した命名を維持**:
   - ワークショップ全体で標準プレフィックスを使用
   - 命名規則を文書化
   - 本番の命名競合を回避

**タグベースのクリーンアップが機能しない**:
- リソースがタグ付けを有効にして作成されたことを確認
- プロビジョニング中にタグ付けが失敗したかどうかを確認（プロビジョンスクリプトの出力を参照）
- 命名パターン識別がフォールバックとして使用されます
- `--dry-run` を使用して識別方法を確認することを検討

---

### scripts/create_job.py
**目的**: ネイティブboto3 APIを使用したover-the-airファームウェア更新のためのAWS IoT Jobsの作成。

**機能**:
- **ネイティブboto3実装**: より良いパフォーマンスのための直接API呼び出し
- インタラクティブなモノグループ選択（単一または複数）
- ARN解決を伴うパッケージバージョン選択
- 継続的なジョブ構成（新しいデバイスを自動的に含む）
- 事前署名URL構成（1時間の有効期限）
- 複数グループターゲティングサポート
- **強化されたジョブタイプ**: OTAとカスタムジョブタイプの両方をサポート
- **高度な構成**: ロールアウトポリシー、中止基準、タイムアウト設定

**ジョブ構成**:
- タイムスタンプ付きの自動生成されたジョブID
- AWS IoT事前署名URLプレースホルダー
- リソースの適切なARNフォーマット
- 包括的なジョブドキュメント構造
- **教育的コンテンツ**: ジョブ構成オプションを説明

---

### scripts/simulate_job_execution.py
**目的**: ネイティブboto3 APIを使用したファームウェア更新中の現実的なデバイス動作のシミュレーション。

**機能**:
- **ネイティブboto3実装**: IoT Jobs Data APIとの直接統合
- 事前署名URLを介した実際のAmazon S3アーティファクトダウンロード
- **高性能並列実行**（セマフォ制御付き150 TPS）
- 構成可能な成功/失敗率
- **可視的なプラン準備** - 各デバイスに成功/失敗ステータスが割り当てられていることを表示
- **ユーザー確認** - プラン準備後に続行するかどうかを尋ねる
- **操作の可視性** - 各デバイスのダウンロード進行状況とジョブステータス更新を表示
- **強化されたエラー処理**: 堅牢なboto3例外管理
- 詳細なレポート付きの進行状況追跡
- **クリーンなJSONフォーマット**: 適切にフォーマットされたジョブドキュメント表示

**プロセスフロー**:
1. ネイティブAPIを使用してアクティブなジョブをスキャン
2. 保留中の実行を取得（QUEUED/IN_PROGRESS）
3. **実行プランを準備** - デバイスの割り当てを表示し、確認を求める
4. Amazon S3から実際のファームウェアをダウンロード（デバイスごとの進行状況を表示）
5. IoT Jobs Data APIを使用してジョブ実行ステータスを更新
6. 包括的な成功/失敗統計をレポート

**パフォーマンスの改善**:
- **並列処理**: デバッグモードでない場合の同時実行
- **レート制限**: インテリジェントなセマフォベースのスロットリング
- **メモリ効率**: 大きなファームウェアファイルのストリーミングダウンロード

**可視性の改善**:
- プラン準備の表示: `[1/100] Vehicle-VIN-001 -> SUCCESS`
- ダウンロード進行状況の表示: `Vehicle-VIN-001: Downloading firmware from S3...`
- ファイルサイズの確認: `Vehicle-VIN-001: Downloaded 2.1KB firmware`
- ステータス更新の表示: `Vehicle-VIN-001: Job execution SUCCEEDED`

---

### scripts/explore_jobs.py
**目的**: ネイティブboto3 APIを使用した監視とトラブルシューティングのためのAWS IoT Jobsのインタラクティブな探索。

**メニューオプション**:
1. **すべてのジョブをリスト** - 並列スキャンによるすべてのステータスの概要
2. **特定のジョブを探索** - クリーンなJSONフォーマットによる詳細なジョブ構成
3. **ジョブ実行を探索** - IoT Jobs Data APIを使用した個々のデバイスの進行状況
4. **ジョブ実行をリスト** - 並列ステータスチェックによるジョブのすべての実行
5. **ジョブをキャンセル** - 影響分析と教育的ガイダンスによるアクティブなジョブのキャンセル
6. **ジョブを削除** - 自動フォースフラグ処理による完了/キャンセルされたジョブの削除
7. **統計を表示** - ヘルスアセスメントと推奨事項を含む包括的なジョブ分析

**機能**:
- **ネイティブboto3実装**: より良いパフォーマンスのための直接API統合
- **並列ジョブスキャン**: すべてのジョブ状態にわたる同時ステータスチェック
- **クリーンなJSON表示**: エスケープ文字なしで適切にフォーマットされたジョブドキュメント
- 色分けされたステータスインジケーター
- 利用可能なジョブリストによるインタラクティブなジョブ選択
- 詳細な事前署名URL構成表示
- 色分けされた実行サマリー統計
- **強化されたエラー処理**: 堅牢なboto3例外管理
- 継続的な探索ループ
- **ジョブライフサイクル管理**: 安全確認付きのキャンセルおよび削除操作
- **高度な分析**: ヘルスアセスメント付きの包括的な統計

**ジョブキャンセル機能**:
- アクティブなジョブをスキャン（IN_PROGRESS、SCHEDULED）
- ジョブの詳細とターゲット数を表示
- ステータス別の実行カウントによる影響分析（QUEUED、IN_PROGRESS、SUCCEEDED、FAILED）
- ジョブをキャンセルするタイミングと理由を説明する教育的コンテンツ
- 続行するために「CANCEL」と入力する必要がある安全確認
- 監査証跡用のオプションのキャンセルコメント
- リアルタイムステータス更新

**ジョブ削除機能**:
- 削除可能なジョブをスキャン（COMPLETED、CANCELED）
- ジョブ完了タイムスタンプを表示
- フォースフラグが必要かどうかを判断するために実行履歴をチェック
- 削除の影響に関する教育的コンテンツ
- 実行が存在する場合の自動フォースフラグ
- 続行するために「DELETE」と入力する必要がある安全確認
- キャンセルと削除操作の違いを説明

**統計表示機能**:
- 包括的なジョブ概要（ステータス、作成/完了日、ターゲット）
- ステータス別のパーセンテージ付き実行統計
- 成功/失敗率の計算
- すべての実行状態の詳細な内訳
- ヘルスアセスメント（優秀 ≥95%、良好 ≥80%、不良 ≥50%、危機的 <50%）
- 実行状態と失敗パターンに関する教育的コンテンツ
- ジョブ状態に基づくコンテキスト対応の推奨事項:
  - 実行なし: デバイスの接続性とグループメンバーシップを確認
  - 早期キャンセル: キャンセル理由を確認
  - デバイス削除: デバイスの存在を確認
  - 進行中: 待機して監視
  - 高い失敗率: 調査してキャンセルを検討
  - 中程度の失敗: 注意深く監視
  - 優れたパフォーマンス: 成功パターンを文書化

**パフォーマンスの改善**:
- **並列処理**: デバッグモードでない場合の同時操作
- **インテリジェントなページネーション**: 大きなジョブリストの効率的な処理
- **レート制限**: セマフォによる適切なAPIスロットリング

---



### scripts/manage_packages.py
**目的**: ネイティブboto3 APIを使用したAWS IoTソフトウェアパッケージ、デバイス追跡、バージョンロールバックの包括的な管理。

**操作**:
1. **パッケージを作成** - 新しいソフトウェアパッケージコンテナを作成
2. **バージョンを作成** - S3ファームウェアアップロードと公開を伴うバージョンを追加（学習モーメント付き）
3. **パッケージをリスト** - インタラクティブな説明オプション付きでパッケージを表示
4. **パッケージを説明** - バージョン探索付きでパッケージの詳細を表示
5. **バージョンを説明** - 特定のバージョンの詳細とAmazon S3アーティファクトを表示
6. **構成を確認** - パッケージ構成ステータスとIAMロールを表示
7. **構成を有効化** - IAMロール作成を伴う自動Shadow更新を有効化
8. **構成を無効化** - 自動Shadow更新を無効化
9. **デバイスバージョンを確認** - 特定のデバイスの$package Shadowを検査（複数デバイスサポート）
10. **バージョンを復元** - Fleet Indexingを使用したフリート全体のバージョンロールバック

**主な機能**:
- **Amazon S3統合**: バージョニング付きの自動ファームウェアアップロード
- **インタラクティブナビゲーション**: リスト、説明、バージョン操作間のシームレスなフロー
- **パッケージ構成管理**: Jobs-to-Shadow統合の制御
- **デバイス追跡**: 個々のデバイスパッケージバージョン検査
- **フリートロールバック**: Fleet Indexingクエリを使用したバージョン復元
- **教育的アプローチ**: ワークフロー全体を通じた学習モーメント
- **IAMロール管理**: パッケージ構成のための自動ロール作成

**パッケージ構成**:
- **ステータス確認**: 有効/無効状態とIAMロールARNを表示
- **有効化**: $package Shadow権限を持つIoTPackageConfigRoleを作成
- **無効化**: ジョブ完了時の自動Shadow更新を停止
- **教育的**: Jobs-to-Shadow統合とIAM要件を説明

**デバイスバージョン追跡**:
- **複数デバイスサポート**: 複数のデバイスを順次確認
- **$package Shadow検査**: 現在のファームウェアバージョンとメタデータを表示
- **タイムスタンプ表示**: 各パッケージの最終更新情報
- **エラー処理**: デバイスまたはShadowが見つからない場合の明確なメッセージ

**バージョンロールバック**:
- **Fleet Indexingクエリ**: モノタイプとバージョンでデバイスを検索
- **デバイスリストプレビュー**: 復元されるデバイスを表示（最初の10個 + カウント）
- **確認が必要**: Shadow更新を続行するには「REVERT」と入力
- **個別デバイスステータス**: デバイスごとの復元成功/失敗を表示
- **進行状況追跡**: 成功カウント付きのリアルタイム更新ステータス
- **教育的**: ロールバックの概念とShadow管理を説明

**ロールバックの可視性**:
- デバイスプレビュー: `1. Vehicle-VIN-001`、`2. Vehicle-VIN-002`、`... および90台以上のデバイス`
- 個別結果: `Vehicle-VIN-001: バージョン1.0.0に復元されました`
- 失敗した試行: `Vehicle-VIN-002: 復元に失敗しました`

**学習の焦点**:
- 作成からロールバックまでの完全なファームウェアライフサイクル
- パッケージ構成と自動Shadow更新
- デバイスインベントリ管理と追跡
- バージョン管理操作のためのFleet Indexing

---

### scripts/manage_dynamic_groups.py
**目的**: ネイティブboto3 APIを使用したFleet Indexing検証による動的モノグループの包括的な管理。

**操作**:
1. **動的グループを作成** - 2つの作成方法:
   - **ガイド付きウィザード**: インタラクティブな基準選択
   - **カスタムクエリ**: 直接Fleet Indexingクエリ入力
2. **動的グループをリスト** - メンバー数とクエリ付きですべてのグループを表示
3. **動的グループを削除** - 確認付きの安全な削除
4. **クエリをテスト** - カスタムFleet Indexingクエリを検証

**作成方法**:
- **ガイド付きウィザード**（すべてオプション）:
  - 国: 単一または複数（例: US,CA,MX）
  - モノタイプ: 車両カテゴリ（例: SedanVehicle）
  - バージョン: 単一または複数（例: 1.0.0,1.1.0）
  - バッテリーレベル: 比較（例: >50、<30、=75）
- **カスタムクエリ**: 直接Fleet Indexingクエリ文字列入力

**機能**:
- **デュアル作成モード**: ガイド付きウィザードまたはカスタムクエリ入力
- スマートグループ命名（自動生成またはカスタム）
- Fleet Indexingクエリの構築と検証
- **リアルタイムデバイスマッチングプレビュー**（作成前に一致するデバイスを表示）
- 既存グループのメンバー数表示
- 確認プロンプト付きの安全な削除
- カスタムクエリテスト機能
- クエリ検証により空のグループ作成を防止

**クエリ例**:
- 単一基準: `thingTypeName:SedanVehicle AND attributes.country:US`
- 複数基準: `thingTypeName:SedanVehicle AND attributes.country:(US OR CA) AND shadow.reported.batteryStatus:[50 TO *]`
- パッケージバージョン: `shadow.name.\$package.reported.SedanVehicle.version:1.1.0`
- カスタム複雑: `(thingTypeName:SedanVehicle OR thingTypeName:SUVVehicle) AND attributes.country:US AND shadow.reported.batteryStatus:[30 TO 80]`

---

### scripts/check_syntax.py
**目的**: CI/CDパイプライン用の公開前構文検証。

**チェック**:
- すべてのスクリプトのPython構文検証
- インポート可用性検証
- requirements.txt検証
- 依存関係リスト

**使用法**: GitHub Actionsワークフローによって自動実行

---

## スクリプトの依存関係

### 必要なPythonパッケージ
- `boto3>=1.40.27` - AWS SDK for Python（パッケージアーティファクトサポート用の最新バージョン）
- `colorama>=0.4.4` - ターミナルカラー
- `requests>=2.25.1` - Amazon S3ダウンロード用のHTTPリクエスト

### 使用されるAWSサービス
- **AWS IoT Core** - モノ管理、ジョブ、Shadow
- **AWS IoT Device Management** - ソフトウェアパッケージ、Fleet Indexing
- **Amazon S3** - バージョニング付きファームウェアストレージ
- **AWS Identity and Access Management (IAM)** - 安全なアクセスのためのロールとポリシー

### AWS認証情報要件
- 以下を介して構成された認証情報:
  - `aws configure`（AWS CLI）
  - 環境変数（AWS_ACCESS_KEY_ID、AWS_SECRET_ACCESS_KEY）
  - IAMロール（EC2/Lambda実行用）
  - AWS認証情報ファイル
- AWS IoT、Amazon S3、IAM操作のための適切なIAM権限
- リージョン構成（AWS_DEFAULT_REGION環境変数または認証情報）

## 教育的機能

### 学習モーメント
各スクリプトには以下を説明する教育的な一時停止が含まれています:
- AWS IoTの概念とアーキテクチャ
- デバイス管理のベストプラクティス
- セキュリティの考慮事項
- スケーラビリティパターン

### 進行状況追跡
- リアルタイム操作ステータス
- 成功/失敗カウント
- パフォーマンスメトリクス（TPS、期間）
- 読みやすい色分けされた出力

### デバッグモード
すべてのスクリプトで利用可能:
- パラメータ付きのすべてのAWS SDK（boto3）API呼び出しを表示
- JSON形式で完全なAPIレスポンスを表示
- 完全なスタックトレース付きの詳細なエラー情報を提供
- **順次処理**: クリーンなデバッグ出力のために操作を順次実行
- AWS APIのトラブルシューティングと学習に役立ちます

## パフォーマンス特性

### レート制限
スクリプトはAWS APIリミットを尊重します:
- モノ操作: 80 TPS（100 TPSリミット）
- モノタイプ: 8 TPS（10 TPSリミット）
- 動的グループ: 4 TPS（5 TPSリミット）
- ジョブ実行: 150 TPS（200 TPSリミット）
- パッケージ操作: 8 TPS（10 TPSリミット）

### 並列処理
- **ネイティブboto3統合**: より良いパフォーマンスのための直接AWS SDK呼び出し
- 同時操作のためのThreadPoolExecutor（デバッグモードでない場合）
- **インテリジェントなレート制限**: AWS APIリミットを尊重するセマフォ
- **スレッドセーフな進行状況追跡**: 同時操作監視
- **強化されたエラー処理**: 堅牢なboto3 ClientError例外管理
- **デバッグモードオーバーライド**: クリーンな出力のためのデバッグモードでの順次処理

### メモリ管理
- 大きなファイルのストリーミングダウンロード
- 一時ファイルのクリーンアップ
- 効率的なJSON解析
- 終了時のリソースクリーンアップ
