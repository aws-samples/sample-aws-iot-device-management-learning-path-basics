# 詳細なスクリプトドキュメント

このドキュメントは、AWS IoT Device Managementプロジェクトの各スクリプトに関する包括的な情報を提供します。すべてのスクリプトは、最適なパフォーマンスと信頼性のためにネイティブAWS SDK（boto3）を使用しています。

## コアスクリプト

### scripts/provision_script.py
**目的**: ネイティブboto3 APIを使用したデバイス管理シナリオのための完全なAWS IoTインフラストラクチャプロビジョニング。

**機能**:
- 検索可能な属性（customerId、country、manufacturingDate）を持つモノタイプを作成
- VINスタイルの命名（Vehicle-VIN-001）で数千のIoTデバイスをプロビジョニング
- ファームウェアパッケージ用のバージョニング付きAmazon S3ストレージをセットアップ
- 複数のバージョンを持つAWS IoTソフトウェアパッケージを作成
- デバイスクエリ用のAWS IoT Fleet Indexingを構成
- 安全な操作のためのAWS Identity and Access Management（IAM）ロールを確立
- 国別の静的モノグループを作成（Fleet命名規則）
- **並列処理**: より高速なプロビジョニングのための同時操作
- **強化されたエラー処理**: 堅牢なboto3例外処理

**インタラクティブ入力**:
1. モノタイプ（デフォルト: SedanVehicle,SUVVehicle,TruckVehicle）
2. パッケージバージョン（デフォルト: 1.0.0,1.1.0）
3. 大陸選択（1-7）
4. 国（カウントまたは特定のコード）
5. デバイス数（デフォルト: 100）

**教育的な一時停止**: IoTコンセプトを説明する8つの学習モーメント

**レート制限**: インテリジェントなAWS APIスロットリング（モノは80 TPS、モノタイプは8 TPS）

**パフォーマンス**: デバッグモードでない場合は並列実行、デバッグモードではクリーンな出力のために順次実行

---

### scripts/cleanup_script.py
**目的**: ネイティブboto3 APIを使用して継続的なコストを回避するためのAWS IoTリソースの安全な削除。

**クリーンアップオプション**:
1. **すべてのリソース** - 完全なインフラストラクチャクリーンアップ
2. **モノのみ** - デバイスを削除するがインフラストラクチャは保持
3. **モノグループのみ** - グループ化を削除するがデバイスは保持

**機能**:
- **ネイティブboto3実装**: CLI依存関係なし、より良いエラー処理
- インテリジェントなレート制限を持つ**並列処理**
- **強化されたS3クリーンアップ**: ページネーターを使用した適切なバージョン管理されたオブジェクトの削除
- 静的グループと動的グループを自動的に区別
- モノタイプの非推奨化を処理（5分待機）
- ステータス監視付きでAWS IoT Jobsをキャンセルおよび削除
- 包括的なIAMロールとポリシーのクリーンアップ
- Fleet Indexing構成を無効化
- **Shadowクリーンアップ**: クラシックと$package shadowの両方を削除
- **プリンシパルのデタッチ**: 証明書とポリシーを適切にデタッチ

**安全性**: 確認のために「DELETE」と入力する必要があります

**パフォーマンス**: AWS APIリミットを尊重した並列実行（モノ80 TPS、動的グループ4 TPS）

---

### scripts/create_job.py
**目的**: ネイティブboto3 APIを使用したover-the-airファームウェア更新のためのAWS IoT Jobsの作成。

**機能**:
- **ネイティブboto3実装**: より良いパフォーマンスのための直接API呼び出し
- インタラクティブなモノグループ選択（単一または複数）
- ARN解決を伴うパッケージバージョン選択
- 継続的なジョブ構成（新しいデバイスを自動的に含む）
- 事前署名URL構成（1時間の有効期限）
- 複数グループターゲティングサポート
- **強化されたジョブタイプ**: OTAとカスタムジョブタイプの両方をサポート
- **高度な構成**: ロールアウトポリシー、中止基準、タイムアウト設定

**ジョブ構成**:
- タイムスタンプ付きの自動生成されたジョブID
- AWS IoT事前署名URLプレースホルダー
- リソースの適切なARNフォーマット
- 包括的なジョブドキュメント構造
- **教育的コンテンツ**: ジョブ構成オプションを説明

---

### scripts/simulate_job_execution.py
**目的**: ネイティブboto3 APIを使用したファームウェア更新中の現実的なデバイス動作のシミュレーション。

**機能**:
- **ネイティブboto3実装**: IoT Jobs Data APIとの直接統合
- 事前署名URLを介した実際のAmazon S3アーティファクトダウンロード
- **高性能並列実行**（セマフォ制御付き150 TPS）
- 構成可能な成功/失敗率
- **可視的なプラン準備** - 各デバイスに成功/失敗ステータスが割り当てられていることを表示
- **ユーザー確認** - プラン準備後に続行するかどうかを尋ねる
- **操作の可視性** - 各デバイスのダウンロード進行状況とジョブステータス更新を表示
- **強化されたエラー処理**: 堅牢なboto3例外管理
- 詳細なレポート付きの進行状況追跡
- **クリーンなJSONフォーマット**: 適切にフォーマットされたジョブドキュメント表示

**プロセスフロー**:
1. ネイティブAPIを使用してアクティブなジョブをスキャン
2. 保留中の実行を取得（QUEUED/IN_PROGRESS）
3. **実行プランを準備** - デバイスの割り当てを表示し、確認を求める
4. Amazon S3から実際のファームウェアをダウンロード（デバイスごとの進行状況を表示）
5. IoT Jobs Data APIを使用してジョブ実行ステータスを更新
6. 包括的な成功/失敗統計をレポート

**パフォーマンスの改善**:
- **並列処理**: デバッグモードでない場合の同時実行
- **レート制限**: インテリジェントなセマフォベースのスロットリング
- **メモリ効率**: 大きなファームウェアファイルのストリーミングダウンロード

**可視性の改善**:
- プラン準備の表示: `[1/100] Vehicle-VIN-001 -> SUCCESS`
- ダウンロード進行状況の表示: `Vehicle-VIN-001: Downloading firmware from S3...`
- ファイルサイズの確認: `Vehicle-VIN-001: Downloaded 2.1KB firmware`
- ステータス更新の表示: `Vehicle-VIN-001: Job execution SUCCEEDED`

---

