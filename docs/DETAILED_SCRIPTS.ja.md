# 詳細スクリプトドキュメント

このドキュメントは、AWS IoT Device Managementプロジェクトの各スクリプトに関する包括的な情報を提供します。すべてのスクリプトは、最適なパフォーマンスと信頼性のためにネイティブAWS SDK（boto3）を使用しています。

## コアスクリプト

### scripts/provision_script.py
**目的**: ネイティブboto3 APIを使用したデバイス管理シナリオのための完全なAWS IoTインフラストラクチャプロビジョニング。

**機能**:
- 検索可能な属性（customerId、country、manufacturingDate）を持つモノタイプを作成
- VINスタイルの命名（Vehicle-VIN-001）で数千のIoTデバイスをプロビジョニング
- ファームウェアパッケージ用のバージョニング付きAmazon S3ストレージをセットアップ
- 複数バージョンのAWS IoTソフトウェアパッケージを作成
- デバイスクエリ用のAWS IoT Fleet Indexingを設定
- 安全な操作のためのAWS Identity and Access Management（IAM）ロールを確立
- 国別の静的モノグループを作成（Fleet命名規則）
- **並列処理**: より高速なプロビジョニングのための同時操作
- **強化されたエラー処理**: 堅牢なboto3例外処理

**対話型入力**:
1. モノタイプ（デフォルト: SedanVehicle,SUVVehicle,TruckVehicle）
2. パッケージバージョン（デフォルト: 1.0.0,1.1.0）
3. 大陸選択（1-7）
4. 国（数または特定のコード）
5. デバイス数（デフォルト: 100）

**教育的な一時停止**: IoTコンセプトを説明する8つの学習モーメント

**レート制限**: インテリジェントなAWS APIスロットリング（モノは80 TPS、モノタイプは8 TPS）

**パフォーマンス**: デバッグモードでない場合は並列実行、デバッグモードではクリーンな出力のために順次実行

---

### scripts/cleanup_script.py
**目的**: ネイティブboto3 APIを使用した継続的なコストを回避するためのAWS IoTリソースの安全な削除。

**クリーンアップオプション**:
1. **すべてのリソース** - 完全なインフラストラクチャクリーンアップ
2. **モノのみ** - デバイスを削除するがインフラストラクチャは保持
3. **モノグループのみ** - グループ化を削除するがデバイスは保持

**機能**:
- **ネイティブboto3実装**: CLI依存関係なし、より良いエラー処理
- インテリジェントなレート制限付き**並列処理**
- **強化されたS3クリーンアップ**: ページネーターを使用した適切なバージョン管理オブジェクトの削除
- 静的グループと動的グループを自動的に区別
- モノタイプの非推奨化を処理（5分待機）
- ステータス監視付きでAWS IoTジョブをキャンセルおよび削除
- 包括的なIAMロールとポリシーのクリーンアップ
- Fleet Indexing設定を無効化
- **シャドウクリーンアップ**: クラシックシャドウと$packageシャドウの両方を削除
- **プリンシパルのデタッチ**: 証明書とポリシーを適切にデタッチ

**安全性**: 確認のために「DELETE」と入力する必要があります

**パフォーマンス**: AWS APIの制限を尊重した並列実行（モノは80 TPS、動的グループは4 TPS）

---

### scripts/create_job.py
**目的**: ネイティブboto3 APIを使用したOTAファームウェア更新のためのAWS IoTジョブの作成。

**機能**:
- **ネイティブboto3実装**: より良いパフォーマンスのための直接API呼び出し
- 対話型モノグループ選択（単一または複数）
- ARN解決付きパッケージバージョン選択
- 継続的ジョブ設定（新しいデバイスを自動的に含む）
- 署名付きURL設定（1時間の有効期限）
- 複数グループターゲティングサポート
- **強化されたジョブタイプ**: OTAとカスタムジョブタイプの両方をサポート
- **高度な設定**: ロールアウトポリシー、中止基準、タイムアウト設定

**ジョブ設定**:
- タイムスタンプ付き自動生成ジョブID
- AWS IoT署名付きURLプレースホルダー
- リソースの適切なARNフォーマット
- 包括的なジョブドキュメント構造
- **教育的コンテンツ**: ジョブ設定オプションを説明

---

### scripts/simulate_job_execution.py
**目的**: ネイティブboto3 APIを使用したファームウェア更新中の現実的なデバイス動作のシミュレーション。

**機能**:
- **ネイティブboto3実装**: IoT Jobs Data APIとの直接統合
- 署名付きURLを介した実際のAmazon S3アーティファクトダウンロード
- **高性能並列実行**（セマフォ制御付き150 TPS）
- 設定可能な成功/失敗率
- **可視的なプラン準備** - 各デバイスに成功/失敗ステータスが割り当てられる様子を表示
- **ユーザー確認** - プラン準備後に続行するかどうかを尋ねる
- **操作の可視性** - 各デバイスのダウンロード進行状況とジョブステータス更新を表示
- **強化されたエラー処理**: 堅牢なboto3例外管理
- 詳細なレポート付き進行状況追跡
- **クリーンなJSONフォーマット**: 適切にフォーマットされたジョブドキュメント表示

**プロセスフロー**:
1. ネイティブAPIを使用してアクティブなジョブをスキャン
2. 保留中の実行を取得（QUEUED/IN_PROGRESS）
3. **実行プランを準備** - デバイスの割り当てを表示し、確認を求める
4. Amazon S3から実際のファームウェアをダウンロード（デバイスごとの進行状況を表示）
5. IoT Jobs Data APIを使用してジョブ実行ステータスを更新
6. 包括的な成功/失敗統計をレポート

**パフォーマンスの改善**:
- **並列処理**: デバッグモードでない場合の同時実行
- **レート制限**: セマフォベースのインテリジェントなスロットリング
- **メモリ効率**: 大きなファームウェアファイルのストリーミングダウンロード

**可視性の改善**:
- プラン準備の表示: `[1/100] Vehicle-VIN-001 -> SUCCESS`
- ダウンロード進行状況の表示: `Vehicle-VIN-001: Downloading firmware from S3...`
- ファイルサイズの確認: `Vehicle-VIN-001: Downloaded 2.1KB firmware`
- ステータス更新の表示: `Vehicle-VIN-001: Job execution SUCCEEDED`

---

### scripts/explore_jobs.py
**目的**: ネイティブboto3 APIを使用した監視とトラブルシューティングのためのAWS IoTジョブの対話型探索。

**メニューオプション**:
1. **すべてのジョブをリスト** - 並列スキャンによるすべてのステータスの概要
2. **特定のジョブを探索** - クリーンなJSONフォーマットによる詳細なジョブ設定
3. **ジョブ実行を探索** - IoT Jobs Data APIを使用した個別デバイスの進行状況
4. **ジョブ実行をリスト** - 並列ステータスチェック付きジョブのすべての実行

**機能**:
- **ネイティブboto3実装**: より良いパフォーマンスのための直接API統合
- **並列ジョブスキャン**: すべてのジョブ状態にわたる同時ステータスチェック
- **クリーンなJSON表示**: エスケープ文字なしで適切にフォーマットされたジョブドキュメント
- 色分けされたステータスインジケーター
- 利用可能なジョブリスト付き対話型ジョブ選択
- 詳細な署名付きURL設定表示
- 色分けされた実行サマリー統計
- **強化されたエラー処理**: 堅牢なboto3例外管理
- 継続的な探索ループ

**パフォーマンスの改善**:
- **並列処理**: デバッグモードでない場合の同時操作
- **インテリジェントなページネーション**: 大きなジョブリストの効率的な処理
- **レート制限**: セマフォによる適切なAPIスロットリング

---

### scripts/manage_packages.py
**目的**: ネイティブboto3 APIを使用したAWS IoTソフトウェアパッケージ、デバイス追跡、バージョンロールバックの包括的な管理。

**操作**:
1. **パッケージを作成** - 新しいソフトウェアパッケージコンテナを作成
2. **バージョンを作成** - S3ファームウェアアップロードと公開でバージョンを追加（学習モーメント付き）
3. **パッケージをリスト** - 対話型記述オプション付きでパッケージを表示
4. **パッケージを記述** - バージョン探索付きでパッケージの詳細を表示
5. **バージョンを記述** - 特定のバージョンの詳細とAmazon S3アーティファクトを表示
6. **設定を確認** - パッケージ設定ステータスとIAMロールを表示
7. **設定を有効化** - IAMロール作成で自動シャドウ更新を有効化
8. **設定を無効化** - 自動シャドウ更新を無効化
9. **デバイスバージョンを確認** - 特定のデバイスの$packageシャドウを検査（マルチデバイスサポート）
10. **バージョンを復元** - Fleet Indexingを使用したフリート全体のバージョンロールバック

**主な機能**:
- **Amazon S3統合**: バージョニング付き自動ファームウェアアップロード
- **対話型ナビゲーション**: リスト、記述、バージョン操作間のシームレスなフロー
- **パッケージ設定管理**: Jobs-to-Shadow統合の制御
- **デバイス追跡**: 個別デバイスパッケージバージョン検査
- **フリートロールバック**: Fleet Indexingクエリを使用したバージョン復元
- **教育的アプローチ**: ワークフロー全体を通じた学習モーメント
- **IAMロール管理**: パッケージ設定のための自動ロール作成

**パッケージ設定**:
- **ステータスを確認**: 有効/無効状態とIAMロールARNを表示
- **有効化**: $packageシャドウ権限を持つIoTPackageConfigRoleを作成
- **無効化**: ジョブ完了時の自動シャドウ更新を停止
- **教育的**: Jobs-to-Shadow統合とIAM要件を説明

**デバイスバージョン追跡**:
- **マルチデバイスサポート**: 複数のデバイスを順次確認
- **$packageシャドウ検査**: 現在のファームウェアバージョンとメタデータを表示
- **タイムスタンプ表示**: 各パッケージの最終更新情報
- **エラー処理**: 欠落しているデバイスまたはシャドウの明確なメッセージ

**バージョンロールバック**:
- **Fleet Indexingクエリ**: モノタイプとバージョンでデバイスを検索
- **デバイスリストプレビュー**: 復元されるデバイスを表示（最初の10個+カウント）
- **確認が必要**: シャドウ更新を続行するには「REVERT」と入力
- **個別デバイスステータス**: デバイスごとの復元成功/失敗を表示
- **進行状況追跡**: 成功カウント付きリアルタイム更新ステータス
- **教育的**: ロールバックコンセプトとシャドウ管理を説明

**ロールバックの可視性**:
- デバイスプレビュー: `1. Vehicle-VIN-001`、`2. Vehicle-VIN-002`、`... および90台以上のデバイス`
- 個別結果: `Vehicle-VIN-001: Reverted to version 1.0.0`
- 失敗した試行: `Vehicle-VIN-002: Failed to revert`

**学習の焦点**:
- 作成からロールバックまでの完全なファームウェアライフサイクル
- パッケージ設定と自動シャドウ更新
- デバイスインベントリ管理と追跡
- バージョン管理操作のためのFleet Indexing

---

### scripts/manage_dynamic_groups.py
**目的**: ネイティブboto3 APIを使用したFleet Indexing検証付き動的モノグループの包括的な管理。

**操作**:
1. **動的グループを作成** - 2つの作成方法:
   - **ガイド付きウィザード**: 対話型基準選択
   - **カスタムクエリ**: Fleet Indexingクエリの直接入力
2. **動的グループをリスト** - メンバー数とクエリ付きですべてのグループを表示
3. **動的グループを削除** - 確認付き安全な削除
4. **クエリをテスト** - カスタムFleet Indexingクエリを検証

**作成方法**:
- **ガイド付きウィザード**（すべてオプション）:
  - 国: 単一または複数（例: US,CA,MX）
  - モノタイプ: 車両カテゴリ（例: SedanVehicle）
  - バージョン: 単一または複数（例: 1.0.0,1.1.0）
  - バッテリーレベル: 比較（例: >50、<30、=75）
- **カスタムクエリ**: Fleet Indexingクエリ文字列の直接入力

**機能**:
- **デュアル作成モード**: ガイド付きウィザードまたはカスタムクエリ入力
- スマートグループ命名（自動生成またはカスタム）
- Fleet Indexingクエリの構築と検証
- **リアルタイムデバイスマッチングプレビュー**（作成前に一致するデバイスを表示）
- 既存グループのメンバー数表示
- 確認プロンプト付き安全な削除
- カスタムクエリテスト機能
- クエリ検証により空のグループ作成を防止

**クエリの例**:
- 単一基準: `thingTypeName:SedanVehicle AND attributes.country:US`
- 複数基準: `thingTypeName:SedanVehicle AND attributes.country:(US OR CA) AND shadow.reported.batteryStatus:[50 TO *]`
- パッケージバージョン: `shadow.name.\$package.reported.SedanVehicle.version:1.1.0`
- カスタム複雑: `(thingTypeName:SedanVehicle OR thingTypeName:SUVVehicle) AND attributes.country:US AND shadow.reported.batteryStatus:[30 TO 80]`

---

### scripts/check_syntax.py
**目的**: CI/CDパイプライン用の公開前構文検証。

**チェック**:
- すべてのスクリプトのPython構文検証
- インポート可用性検証
- requirements.txt検証
- 依存関係リスト

**使用法**: GitHub Actionsワークフローによって自動的に実行

---

## スクリプトの依存関係

### 必要なPythonパッケージ
- `boto3>=1.40.27` - AWS SDK for Python（パッケージアーティファクトサポートのための最新バージョン）
- `colorama>=0.4.4` - ターミナルカラー
- `requests>=2.25.1` - Amazon S3ダウンロード用のHTTPリクエスト

### 使用されるAWSサービス
- **AWS IoT Core** - モノ管理、ジョブ、シャドウ
- **AWS IoT Device Management** - ソフトウェアパッケージ、Fleet Indexing
- **Amazon S3** - バージョニング付きファームウェアストレージ
- **AWS Identity and Access Management (IAM)** - 安全なアクセスのためのロールとポリシー

### AWS認証情報の要件
- 以下を介して設定された認証情報:
  - `aws configure`（AWS CLI）
  - 環境変数（AWS_ACCESS_KEY_ID、AWS_SECRET_ACCESS_KEY）
  - IAMロール（EC2/Lambda実行用）
  - AWS認証情報ファイル
- AWS IoT、Amazon S3、IAM操作のための適切なIAM権限
- リージョン設定（AWS_DEFAULT_REGION環境変数または認証情報）

## 教育的機能

### 学習モーメント
各スクリプトには以下を説明する教育的な一時停止が含まれています:
- AWS IoTのコンセプトとアーキテクチャ
- デバイス管理のベストプラクティス
- セキュリティの考慮事項
- スケーラビリティパターン

### 進行状況追跡
- リアルタイム操作ステータス
- 成功/失敗カウント
- パフォーマンスメトリクス（TPS、期間）
- 読みやすい色分けされた出力

### デバッグモード
すべてのスクリプトで利用可能:
- パラメータ付きのすべてのAWS SDK（boto3）API呼び出しを表示
- JSON形式で完全なAPIレスポンスを表示
- 完全なスタックトレース付きの詳細なエラー情報を提供
- **順次処理**: クリーンなデバッグ出力のために操作を順次実行
- AWS APIのトラブルシューティングと学習に役立つ

## パフォーマンス特性

### レート制限
スクリプトはAWS APIの制限を尊重します:
- モノ操作: 80 TPS（100 TPS制限）
- モノタイプ: 8 TPS（10 TPS制限）
- 動的グループ: 4 TPS（5 TPS制限）
- ジョブ実行: 150 TPS（200 TPS制限）
- パッケージ操作: 8 TPS（10 TPS制限）

### 並列処理
- **ネイティブboto3統合**: より良いパフォーマンスのための直接AWS SDK呼び出し
- 同時操作のためのThreadPoolExecutor（デバッグモードでない場合）
- **インテリジェントなレート制限**: AWS APIの制限を尊重するセマフォ
- **スレッドセーフな進行状況追跡**: 同時操作の監視
- **強化されたエラー処理**: 堅牢なboto3 ClientError例外管理
- **デバッグモードオーバーライド**: クリーンな出力のためのデバッグモードでの順次処理

### メモリ管理
- 大きなファイルのストリーミングダウンロード
- 一時ファイルのクリーンアップ
- 効率的なJSON解析
- 終了時のリソースクリーンアップ
